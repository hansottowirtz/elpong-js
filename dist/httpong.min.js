var HP,HPP,HTTPong,base,base1,getOptions;HTTPong=window.HTTPong=HP={},HP["private"]=HPP={log:function(){return console.log.apply(console,["%c HTTPong ","background: #80CBC4; color: #fff"].concat(Array.from(arguments)))},schemes:{},http_function:null,isHpe:function(e){return e.constructor===HP.Element},isHpc:function(e){return e.constructor===HP.Collection}},HP.addScheme=function(e){var t;if(t=new HP.Scheme(e),HPP.schemes[t.getName()])throw new Error("A scheme with name "+t.getName()+" already exists");return HPP.schemes[t.getName()]=t},HP.getScheme=function(e){return HPP.schemes[e]},HP.initialize=function(){var e,t,n,r,o,i,l,s,a,c;if(c=document.querySelectorAll("meta[name=httpong-scheme]"),!c.length&&!Object.keys(HPP.schemes).length)throw new Error("No scheme added or found");for(n=0,r=c.length;n<r;n++)a=c[n],HP.addScheme(JSON.parse(a.content));o=HPP.schemes;for(s in o){l=o[s],i=l.collections;for(t in i)e=i[t],e.handlePreloadedElements()}return HP},HP.setHttpFunction=function(e){return HPP.http_function=e},HP.Scheme=function(){function e(e,t){null==t&&(t={no_normalize:!1,no_create_collections:!1}),this.data=e,this.collections={},this.api_url=null,t.no_normalize||this.normalize(),t.no_create_collections||this.createCollections()}return e.prototype.getName=function(){return this.data.name},e.prototype.normalize=function(){var e,t,n,r,o,i,l;this.data.name=this.data.name.toLowerCase(),i=this.data.collections,l=[];for(r in i)o=i[r],o.singular||(o.singular=r.slice(0,-1)),o.actions||(o.actions={}),o.collection_actions||(o.collection_actions={}),o.relations||(o.relations={}),(e=o.relations).has_one||(e.has_one={}),(t=o.relations).has_many||(t.has_many={}),l.push((n=o.relations).belongs_to||(n.belongs_to={}));return l},e.prototype.createCollections=function(){var e,t,n,r,o;r=this.data.collections,o=[];for(t in r)n=r[t],this.collections[t]?HPP.log("Collection with name "+t+" already exists in scheme"):(e=new HP.Collection(this,t),o.push(this.collections[t]=e));return o},e.prototype.getCollection=function(e){if(this.collections[e])return this.collections[e];throw new Error("Collection "+e+" does not exist")},e.prototype.getCollectionBySingularName=function(e){var t,n,r;r=this.collections;for(n in r)if(t=r[n],t.getSingularName()===e)return t;throw new Error("Collection "+e+" does not exist")},e.prototype.select=e.prototype.getCollection,e.prototype.setApiUrl=function(e){if(this.api_url=HPP.Helpers.Url.trimSlashes(e),!HP.Util.startsWith(this.api_url,"http://")&&!HP.Util.startsWith(this.api_url,"https://"))return this.api_url="/"+this.api_url},e.prototype.getApiUrl=function(){return this.api_url},e}(),HP.Element=function(){function e(e,t){var n,r;this.collection=e,r=this,this.fields={},this.relations={},n=HPP.Helpers.Collection.getSettings(this.collection),HP.Util.forEach(n.fields,function(e,n){var o;if(e.embedded_element)return HPP.Helpers.Field.handleEmbeddedElement(r,t,n,e);if(e.embedded_collection)return HPP.Helpers.Field.handleEmbeddedCollection(r,t,n,e);if(!e.only_send)return o=t[n],r.setField(n,o,!0)}),HP.Util.forEach(n.relations.has_many,function(e,t){return HPP.Helpers.Element.setupHasManyRelation(r,t,e)}),HP.Util.forEach(n.relations.has_one,function(e,t){return HPP.Helpers.Element.setupHasOneRelation(r,t,e)}),HP.Util.forEach(n.relations.belongs_to,function(e,t){return HPP.Helpers.Element.setupBelongsToRelation(r,t,e)}),this.actions={doGet:function(e){return HPP.Helpers.Element.doAction(r,"GET",e)},doPost:function(e){return HPP.Helpers.Element.doAction(r,"POST",e)},doPut:function(e){return HPP.Helpers.Element.doAction(r,"PUT",e)},doDelete:function(e){return HPP.Helpers.Element.doAction(r,"DELETE",e)}},HP.Util.forEach(n.actions,function(e,t){return r.actions["do"+HP.Util.upperCamelize(t)]=function(n){if(r.isNew()&&!e.without_selector)throw new Error("Element is new");return HPP.Helpers.Element.doCustomAction(r,t,e,n)}}),this.snapshots={getLastPersisted:function(){var e;return r.isNew()?null:(e=null,HP.Util.reverseForIn(r.snapshots.list,function(t,n){if("after_post"===n.tag||"after_put"===n.tag||"after_get"===n.tag||"creation"===n.tag)return e=n,HP.Util.BREAK}),e)},getLastWithTag:function(e){var t;return t=null,HP.Util.isRegex(e)?HP.Util.reverseForIn(r.snapshots.list,function(n,r){if(e.test(r.tag))return t=r,HP.Util.BREAK}):HP.Util.reverseForIn(r.snapshots.list,function(n,r){if(r.tag===e)return t=r,HP.Util.BREAK}),t},getLast:function(){var e;return e=null,HP.Util.reverseForIn(r.snapshots.list,function(t,n){return e=n,HP.Util.BREAK}),e},make:function(e){var t,n,o;return t=Date.now(),n=r.snapshots.list=HPP.Helpers.Snapshot.removeAfter(r.last_snapshot_time,r.snapshots.list),n[t]?r.snapshots.make(e):(o=n[t]={tag:e,time:t,data:HPP.Helpers.Element.getFields(r),revert:function(){return r.undo(t)}},r.last_snapshot_time=t,o)},list:{}},this.last_snapshot_time=null,this.snapshots.make("creation")}return e.prototype.getCollection=function(){return this.collection},e.prototype.getCollectionName=function(){return this.collection.getName()},e.prototype.getSelectorValue=function(){return this.fields[this.collection.selector_name]},e.prototype.getField=function(e){return this.fields[e]},e.prototype.setField=function(e,t){return this.fields[e]=t,this},e.prototype.remove=function(){var e;return e=this,this.isNew()?(HP.Util.removeFromArray(this.getCollection().new_elements,this),{then:function(e){return e()},"catch":function(){}}):this.actions.doDelete().then(function(){var t;return t=e.getCollection().elements,delete t[e.getSelectorValue()]})},e.prototype.save=function(){return this.isNew()?this.actions.doPost():this.actions.doPut()},e.prototype.isNew=function(){if(this.getCollection().new_elements.includes(this)){if(this.getSelectorValue())throw new Error("Element has a selector value but is in new_elements array");return!0}if(this.getSelectorValue())return!1;throw new Error("Element has no selector value but is in elements object")},e.prototype.undo=function(e){var t,n,r,o,i,l,s,a,c;if(null==e&&(e=0),HP.Util.isInteger(e)){if(e>1e6){if(this.snapshots.list[e])return this.mergeWith(this.snapshots.list[e].data),this.last_snapshot_time=e;throw new Error("Diff at time "+e+" does not exist")}if(e<0)throw new Error(e+" is smaller than 0");return r=HPP.Helpers.Snapshot.getSortedArray(this.snapshots.list),s=r.length,o=r.indexOf(this.snapshots.list[this.last_snapshot_time]),n=r[o-e],this.mergeWith(n.data),this.last_snapshot_time=n.time}if(HP.Util.isString(e)){for(t=null,a=HPP.Helpers.Snapshot.getSortedArray(this.snapshots.list),i=0,l=a.length;i<l;i++)c=a[i],c.tag===e&&(t||(t=c));if(t)return this.mergeWith(t.data);throw new Error("No snapshot found with tag "+e)}throw new TypeError("Don't know what to do with "+e)},e.prototype.mergeWith=function(e){var t,n;return n=this,t=HPP.Helpers.Collection.getSettings(this.collection),HP.Util.forEach(t.fields,function(t,r){var o,i;if(o=e[r]){if(t.embedded_element)return HPP.Helpers.Field.handleEmbeddedElement(n,e,r,t);if(t.embedded_collection)return HPP.Helpers.Field.handleEmbeddedCollection(n,e,r,t);if(i=n.fields[r],t.selector&&i!==o&&i&&o)throw new Error("Selector has changed from "+i+" to "+o);return n.setField(r,o,!0)}}),this},e.prototype.isPersisted=function(){var e,t,n,r;if(this.isNew())return!1;e=this.snapshots.getLastPersisted().data,n=HPP.Helpers.Element.getFields(this);for(t in n)if(r=n[t],e[t]!==r)return!1;return!0},e}(),HP.Collection=function(){function e(e,t){var n,r,o,i,l;this.scheme=e,this.name=t,o=this,this.elements={},this.new_elements=[],this.default_pre_element={},this.selector_name=null,l=HPP.Helpers.Collection.getSettings(this),i=l.fields;for(n in i)r=i[n],r.selector&&(this.selector_name=n),r["default"]&&(this.default_pre_element[n]=r["default"]);this.actions={doGetAll:function(e){return HPP.Helpers.Collection.doGetAllAction(o,e)},doGetOne:function(e,t){return HPP.Helpers.Collection.doGetOneAction(o,e,t)}},HP.Util.forEach(l.collection_actions,function(e,t){return o.actions["do"+HP.Util.upperCamelize(t)]=function(n){return HPP.Helpers.Collection.doCustomAction(o,t,e,n)}})}return e.prototype.handlePreloadedElements=function(){var e,t,n,r,o,i,l,s,a,c,u,h,p;for(t=document.querySelectorAll('meta[name=httpong-collection][collection="'+this.name+'"][scheme="'+this.scheme.getName()+'"]'),r=document.querySelectorAll('meta[name=httpong-element][collection="'+this.name+'"][scheme="'+this.scheme.getName()+'"]'),o=0,l=t.length;o<l;o++)for(e=t[o],h=JSON.parse(e.content),i=0,s=h.length;i<s;i++)u=h[i],this.makeOrMerge(u);for(p=[],c=0,a=r.length;c<a;c++)n=r[c],p.push(this.makeOrMerge(JSON.parse(n.content)));return p},e.prototype.getName=function(){return this.name},e.prototype.getPluralName=e.prototype.getName,e.prototype.getSingularName=function(){return HPP.Helpers.Collection.getSingularName(this)},e.prototype.getScheme=function(){return this.scheme},e.prototype.getArray=function(e){var t;return null==e&&(e={without_new:!1}),t=e.without_new?[]:this.new_elements,t.concat(Object.values(this.elements))},e.prototype.find=function(e){return this.elements[e]},e.prototype.findBy=function(e,t,n){var r,o,i,l,s,a,c,u,h,p,f,m,g;if(null==n&&(n={without_new:!1,multiple:!1}),HP.Util.isString(e)){if(r=this.getArray(n),n.multiple){for(g=[],l=0,a=r.length;l<a;l++)o=r[l],o.getField(e,!0)===t&&g.push(o);return g}for(s=0,c=r.length;s<c;s++)if(o=r[s],o.getField(e,!0)===t)return o}else{if(m=e,n=t||{without_new:!1,multiple:!1},r=this.getArray(n),n.multiple){for(g=[],p=0,u=r.length;p<u;p++){o=r[p],i=!0;for(e in m)if(t=m[e],o.getField(e,!0)!==t){i=!1;break}i&&g.push(o)}return g}for(f=0,h=r.length;f<h;f++){o=r[f],i=!0;for(e in m)if(t=m[e],o.getField(e,!0)!==t){i=!1;break}if(i)return o}}},e.prototype.makeNewElement=function(e){var t;return null==e&&(e=this.default_pre_element),t=new HP.Element(this,e),this.addElement(t),t},e.prototype.addElement=function(e){return e.getSelectorValue()?this.elements[e.getSelectorValue()]=e:this.new_elements.push(e)},e.prototype.makeOrMerge=function(e){var t,n;return(n=e[this.selector_name])&&(t=this.find(n))?t.mergeWith(e):this.makeNewElement(e)},e}(),Object.values||(Object.values=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&e.propertyIsEnumerable(n)&&t.push(e[n]);return t}),(base=Array.prototype).includes||(base.includes=function(e){return this.indexOf(e)>-1}),(base1=String.prototype).includes||(base1.includes=function(e){return this.indexOf(e)>-1}),HP.Util={BREAK:new Object,kebab:function(e){return e.toLowerCase().replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,"").replace(/(é|ë)/g,"e").split(" ").join("-")},unkebab:function(e){return e.split("-").join(" ")},unsnake:function(e){return e.split("_").join(" ")},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},camelize:function(e){return e.replace(/_/g," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return 0===t?e.toLowerCase():e.toUpperCase()}).replace(/\s+/g,"")},upperCamelize:function(e){return e.replace(/_/g," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return e.toUpperCase()}).replace(/\s+/g,"")},arrayDiff:function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},removeFromArray:function(e,t){var n;return n=e.indexOf(t),n!==-1&&(e.splice(n,n+1),!0)},copy:function(e){var t,n;if(null===e||"object"!=typeof e)return e;n=e.constructor();for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n},merge:function(e,t){var n;for(n in t)e[n]=t[n];return e},isInteger:function(e){return e===parseInt(e,10)},isNumber:function(e){return isFinite(e)&&!isNaN(parseFloat(e))},isString:function(e){return"string"==typeof e},isRegex:function(e){return e instanceof RegExp},forEach:function(e,t){var n,r;for(n in e)if(r=e[n],e.hasOwnProperty(n)&&t(r,n)===HP.Util.BREAK)break},reverseForIn:function(e,t){var n,r,o,i,l;r=[],n=!1;for(i in e)r.push(i);for(o=r.length-1;o>=0&&!n;)l=t.call(e,r[o],e[r[o]]),l===HP.Util.BREAK&&(n=!0),o--},endsWith:function(e,t){return e.endsWith,e.substr(-t.length)===t},startsWith:function(e,t){return e.startsWith,e.substr(0,t.length)===t}},HPP.Helpers={Url:{createForElement:function(e,t,n,r){var o,i,l,s,a;if(i=n.getCollection(),s=i.getScheme(),o=s.getApiUrl(),!o)throw new Error("Api url has not yet been set");return r.path?(l=HPP.Helpers.Url.trimSlashes(r.path),a=o+"/"+l):(a=o+"/"+i.getName(),t.without_selector||"POST"===e||(a=a+"/"+n.getSelectorValue())),t.method&&(a=a+"/"+(t.path||e)),r.suffix&&(a=a+"/"+r.suffix),a},createForCollection:function(e,t,n){var r;return r=t.getScheme().getApiUrl()+"/"+t.getName(),n.suffix&&(r=r+"/"+n.suffix),r},trimSlashes:function(e){return e.replace(/\/$/,"").replace(/^\//,"")}},Element:{toData:function(e){var t,n,r;return t=e.getCollection(),r=HPP.Helpers.Element.getFields(e),n=r},getFields:function(e){var t,n,r,o,i,l,s;t=e.getCollection(),s=t.getScheme(),i={},l=s.data.collections[t.getName()].fields;for(n in l)r=l[n],r.only_receive||r.embedded_collection||r.embedded_element||(o=e.getField(n),i[n]=o);return i}},Collection:{getSettings:function(e){return e.getScheme().data.collections[e.getName()]},getSingularName:function(e){return HPP.Helpers.Collection.getSettings(e).singular}},Field:{}},HPP.Helpers.Snapshot={getSortedArray:function(e){var t;return t=Object.values(e),t.sort(function(e,t){return e.time-t.time}),t},removeAfter:function(e,t){var n,r,o,i,l;for(n=HPP.Helpers.Snapshot.getSortedArray(t),i={},r=0,o=n.length;r<o;r++)l=n[r],l.time<=e&&(i[l.time]=l);return i}},HPP.Helpers.Collection.doGetAllAction=function(e,t){var n,r,o;return null==t&&(t={}),n=t.data,r=getOptions("GET",HPP.Helpers.Url.createForCollection("GET",e,t),n,t.headers),o=HPP.http_function(r),o.then(function(t){var n,r,o,i,l;for(i=t.data,l=[],n=0,r=i.length;n<r;n++)o=i[n],l.push(e.makeOrMerge(o));return l}),o},HPP.Helpers.Collection.doGetOneAction=function(e,t,n){var r,o,i;return null==n&&(n={}),r=n.data,o=getOptions("GET",HPP.Helpers.Url.createForCollection("GET",e,{suffix:t}),r,n.headers),i=HPP.http_function(o),i.then(function(t){return e.makeOrMerge(t.data)}),i},HPP.Helpers.Collection.doCustomAction=function(e,t,n,r){var o,i,l;return null==r&&(r={}),i=n.method.toUpperCase(),o=r.data,l=getOptions(i,HPP.Helpers.Url.createForCollection("GET",e,{suffix:n.path||t}),o,r.headers),HPP.http_function(l)},HPP.Helpers.Field.handleEmbeddedCollection=function(e,t,n,r){var o,i,l,s;if(l=t[n],l||r.required)return o=e.getCollection(),s=o.getScheme(),i=s.getCollection(n||r.collection),HP.Util.forEach(l,function(e){var t;return t=new HP.Element(i,e),i.addElement(t)})},HPP.Helpers.Field.handleEmbeddedElement=function(e,t,n,r){var o,i,l,s,a,c;if(a=t[n],a||r.required)return i=e.getCollection(),c=i.getScheme(),s=r.collection?c.getCollection(r.collection):c.getCollectionBySingularName(n),l=s.makeOrMerge(a),o=r.associated_field||n+"_"+s.selector_name,e.setField(o,l.getSelectorValue())},HPP.Helpers.Element.setupBelongsToRelation=function(e,t,n){var r,o,i,l,s;return r=e.getCollection(),n.polymorphic||(s=n.collection?r.getScheme().getCollection(n.collection):r.getScheme().getCollectionBySingularName(t)),n.polymorphic?(o=n.collection_field||t+"_collection",i=n.collection_selector_field,l=n.field,e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HPP.Helpers.Element.getPolymorphicBelongsToElement(e,l,o,i,t)}):(l=n.field||t+"_"+s.selector_name,e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HPP.Helpers.Element.getBelongsToElement(e,s,l)})},HPP.Helpers.Element.getBelongsToElement=function(e,t,n){var r;return r=e.getField(n,!0,"belongs_to"),t.find(r)||null},HPP.Helpers.Element.getPolymorphicBelongsToElement=function(e,t,n,r,o){var i,l,s;return l=e.getField(n,!0,"belongs_to_collection"),i=e.getCollection().getScheme().getCollection(l),t||(r||(r=i.selector_name),t=o+"_"+r),s=e.getField(t,!0,"belongs_to"),i.find(s)||null},HPP.Helpers.Element.setupHasManyRelation=function(e,t,n){var r,o,i,l,s;return r=e.getCollection(),o=HPP.Helpers.Collection.getSettings(e.getCollection()),l=r.getScheme().getCollection(n.collection||t),i=n.references_field||t+"_"+l.selector_name+"s",(s=o.fields[i])?e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HPP.Helpers.Element.getHasManyRelationArrayThroughReferencesField(e,l,field_name)}:e.relations["get"+HP.Util.upperCamelize(t)]=HPP.Helpers.Element.getHasManyRelationFunction(e,r,n,l)},HPP.Helpers.Element.getHasManyRelationFunction=function(e,t,n,r){var o,i,l,s;return o=t.getSingularName(),s=HPP.Helpers.Collection.getSettings(r),n.polymorphic?(l=n.as+"_"+t.selector_name,i=n.as+"_collection",function(){return HPP.Helpers.Element.getPolymorphicHasManyRelationArray(e,r,l,i)}):(l=n.field?n.field:n.as?n.as+"_"+t.selector_name:o+"_"+t.selector_name,function(){return HPP.Helpers.Element.getHasManyRelationArray(e,r,l)})},HPP.Helpers.Element.getHasManyRelationArray=function(e,t,n){var r,o,i,l,s,a;for(o=[],a=e.getSelectorValue(),s=t.getArray(),i=0,l=s.length;i<l;i++)r=s[i],a===r.getField(n,!0,"has_many")&&o.push(r);return o},HPP.Helpers.Element.getPolymorphicHasManyRelationArray=function(e,t,n,r){var o,i,l,s,a,c,u;for(l=[],u=e.getSelectorValue(),o=e.getCollection().getName(),c=t.getArray(),s=0,a=c.length;s<a;s++)i=c[s],u===i.getField(n,!0,"has_many")&&o===i.getField(r,!0,"has_many_collection_name")&&l.push(i);return l},HPP.Helpers.Element.getHasManyRelationArrayThroughReferencesField=function(e,t,n){var r,o,i,l,s,a;if(a=e.getField(n,!0,"has_many_array"),!Array.isArray(a))throw new Error("Field "+n+" is not an array, but it should be an array of references to "+t.getName());for(o=[],s=t.getArray(),i=0,l=s.length;i<l;i++)r=s[i],a.includes(e.getSelectorValue())&&o.push(r);return o},HPP.Helpers.Element.setupHasOneRelation=function(e,t,n){var r,o,i,l;return r=e.getCollection(),o=HPP.Helpers.Collection.getSettings(e.getCollection()),l=r.getScheme(),i=n.collection?l.getCollection(n.collection):l.getCollectionBySingularName(t),e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HPP.Helpers.Element.getHasManyRelationFunction(e,r,n,i)()[0]}},getOptions=function(e,t,n,r){return null==r&&(r={}),r.Accept=r["Content-Type"]="application/json",{method:e,url:t,data:JSON.stringify(n||{}),headers:r,dataType:"json",responseType:"json"}},HPP.Helpers.Element.doAction=function(e,t,n){var r,o,i;if(null==n&&(n={}),e.snapshots.make("before_"+t.toLowerCase()),n.data?r=n.data:"GET"!==t&&(r=HPP.Helpers.Element.toData(e)),"POST"===t){if(!e.isNew())throw new Error("Element is not new")}else if(e.isNew())throw new Error("Element is new");return o=getOptions(t,HPP.Helpers.Url.createForElement(t,{},e,n),r,n.headers),i=HPP.http_function(o),i.then(function(n){var r;if(n.data&&e.mergeWith(n.data),e.snapshots.make("after_"+t.toLowerCase()),r=e.getCollection(),r.new_elements.includes(e))return HP.Util.removeFromArray(r.new_elements,e),r.elements[e.getSelectorValue()]=e}),i},HPP.Helpers.Element.doCustomAction=function(e,t,n,r){var o,i,l,s;return null==r&&(r={}),i=n.method.toUpperCase(),e.snapshots.make("before_"+i.toLowerCase()),r.data?o=r.data:n.without_data||(o=HPP.Helpers.Element.toData(e)),l=getOptions(i,HPP.Helpers.Url.createForElement(t,n,e,r),o,r.headers),s=HPP.http_function(l),s.then(function(t){var r,o;if(n.returns_other||(t.data&&e.mergeWith(t.data),e.snapshots.make("after_"+i.toLowerCase())),r=e.getCollection(),(o=e.getSelectorValue())&&r.new_elements.includes(e))return HP.Util.removeFromArray(r.new_elements,e),r.elements[o]=e}),s};