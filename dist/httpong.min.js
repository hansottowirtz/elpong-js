!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.HTTPong=t()}(this,function(){var e,t,n,r,o,i;return n=e={},e["private"]=t={log:function(){return console.log.apply(console,["%c HTTPong ","background: #80CBC4; color: #fff"].concat(Array.from(arguments)))},schemes:{},http_function:null,isHpe:function(t){return t.constructor===e.Element},isHpc:function(t){return t.constructor===e.Collection}},e.addScheme=function(n){var r;if(r=new e.Scheme(n),t.schemes[r.getName()])throw new Error("A scheme with name "+r.getName()+" already exists");return t.schemes[r.getName()]=r},e.getScheme=function(e){return t.schemes[e]},e.initialize=function(){var n,r,o,i,l,s,a,c,u,h;if(h=document.querySelectorAll("meta[name=httpong-scheme]"),!h.length&&!Object.keys(t.schemes).length)throw new Error("No scheme added or found");for(o=0,i=h.length;o<i;o++)u=h[o],e.addScheme(JSON.parse(u.content));l=t.schemes;for(c in l){a=l[c],s=a.collections;for(r in s)n=s[r],n.handlePreloadedElements()}return e},e.setHttpFunction=function(e){return t.http_function=e},e.Scheme=function(){function n(e,t){null==t&&(t={no_normalize:!1,no_create_collections:!1}),this.data=e,this.collections={},this.api_url=null,t.no_normalize||this.normalize(),t.no_create_collections||this.createCollections()}return n.prototype.getName=function(){return this.data.name},n.prototype.normalize=function(){var e,t,n,r,o,i,l;this.data.name=this.data.name.toLowerCase(),i=this.data.collections,l=[];for(r in i)o=i[r],o.singular||(o.singular=r.slice(0,-1)),o.actions||(o.actions={}),o.collection_actions||(o.collection_actions={}),o.relations||(o.relations={}),(e=o.relations).has_one||(e.has_one={}),(t=o.relations).has_many||(t.has_many={}),l.push((n=o.relations).belongs_to||(n.belongs_to={}));return l},n.prototype.createCollections=function(){var n,r,o,i,l;i=this.data.collections,l=[];for(r in i)o=i[r],this.collections[r]?t.log("Collection with name "+r+" already exists in scheme"):(n=new e.Collection(this,r),l.push(this.collections[r]=n));return l},n.prototype.getCollection=function(e){if(this.collections[e])return this.collections[e];throw new Error("Collection "+e+" does not exist")},n.prototype.getCollectionBySingularName=function(e){var t,n,r;r=this.collections;for(n in r)if(t=r[n],t.getSingularName()===e)return t;throw new Error("Collection "+e+" does not exist")},n.prototype.select=n.prototype.getCollection,n.prototype.setApiUrl=function(n){if(this.api_url=t.Helpers.Url.trimSlashes(n),!e.Util.startsWith(this.api_url,"http://")&&!e.Util.startsWith(this.api_url,"https://"))return this.api_url="/"+this.api_url},n.prototype.getApiUrl=function(){return this.api_url},n}(),e.Element=function(){function n(n,r){var o,i;this.collection=n,i=this,this.fields={},this.relations={},o=t.Helpers.Collection.getSettings(this.collection),e.Util.forEach(o.fields,function(e,n){var o;if(e.embedded_element)return t.Helpers.Field.handleEmbeddedElement(i,r,n,e);if(e.embedded_collection)return t.Helpers.Field.handleEmbeddedCollection(i,r,n,e);if(!e.only_send)return o=r[n],i.setField(n,o,!0)}),e.Util.forEach(o.relations.has_many,function(e,n){return t.Helpers.Element.setupHasManyRelation(i,n,e)}),e.Util.forEach(o.relations.has_one,function(e,n){return t.Helpers.Element.setupHasOneRelation(i,n,e)}),e.Util.forEach(o.relations.belongs_to,function(e,n){return t.Helpers.Element.setupBelongsToRelation(i,n,e)}),this.actions={doGet:function(e){return t.Helpers.Element.doAction(i,"GET",e)},doPost:function(e){return t.Helpers.Element.doAction(i,"POST",e)},doPut:function(e){return t.Helpers.Element.doAction(i,"PUT",e)},doDelete:function(e){return t.Helpers.Element.doAction(i,"DELETE",e)}},e.Util.forEach(o.actions,function(n,r){return i.actions["do"+e.Util.upperCamelize(r)]=function(e){if(i.isNew()&&!n.without_selector)throw new Error("Element is new");return t.Helpers.Element.doCustomAction(i,r,n,e)}}),this.snapshots={getLastPersisted:function(){var t;return i.isNew()?null:(t=null,e.Util.reverseForIn(i.snapshots.list,function(n,r){if("after_post"===r.tag||"after_put"===r.tag||"after_get"===r.tag||"creation"===r.tag)return t=r,e.Util.BREAK}),t)},getLastWithTag:function(t){var n;return n=null,e.Util.isRegex(t)?e.Util.reverseForIn(i.snapshots.list,function(r,o){if(t.test(o.tag))return n=o,e.Util.BREAK}):e.Util.reverseForIn(i.snapshots.list,function(r,o){if(o.tag===t)return n=o,e.Util.BREAK}),n},getLast:function(){var t;return t=null,e.Util.reverseForIn(i.snapshots.list,function(n,r){return t=r,e.Util.BREAK}),t},make:function(e){var n,r,o;return n=Date.now(),r=i.snapshots.list=t.Helpers.Snapshot.removeAfter(i.last_snapshot_time,i.snapshots.list),r[n]?i.snapshots.make(e):(o=r[n]={tag:e,time:n,data:t.Helpers.Element.getFields(i),revert:function(){return i.undo(n)}},i.last_snapshot_time=n,o)},list:{}},this.last_snapshot_time=null,this.snapshots.make("creation")}return n.prototype.getCollection=function(){return this.collection},n.prototype.getCollectionName=function(){return this.collection.getName()},n.prototype.getSelectorValue=function(){return this.fields[this.collection.selector_name]},n.prototype.getField=function(e){return this.fields[e]},n.prototype.setField=function(e,t){return this.fields[e]=t,this},n.prototype.remove=function(){var t;return t=this,this.isNew()?(e.Util.removeFromArray(this.getCollection().new_elements,this),{then:function(e){return e()},"catch":function(){}}):this.actions.doDelete().then(function(){var e;return e=t.getCollection().elements,delete e[t.getSelectorValue()]})},n.prototype.save=function(){return this.isNew()?this.actions.doPost():this.actions.doPut()},n.prototype.isNew=function(){if(this.getCollection().new_elements.includes(this)){if(this.getSelectorValue())throw new Error("Element has a selector value but is in new_elements array");return!0}if(this.getSelectorValue())return!1;throw new Error("Element has no selector value but is in elements object")},n.prototype.undo=function(n){var r,o,i,l,s,a,c,u,h;if(null==n&&(n=0),e.Util.isInteger(n)){if(n>1e6){if(this.snapshots.list[n])return this.mergeWith(this.snapshots.list[n].data),this.last_snapshot_time=n;throw new Error("Diff at time "+n+" does not exist")}if(n<0)throw new Error(n+" is smaller than 0");return i=t.Helpers.Snapshot.getSortedArray(this.snapshots.list),c=i.length,l=i.indexOf(this.snapshots.list[this.last_snapshot_time]),o=i[l-n],this.mergeWith(o.data),this.last_snapshot_time=o.time}if(e.Util.isString(n)){for(r=null,u=t.Helpers.Snapshot.getSortedArray(this.snapshots.list),s=0,a=u.length;s<a;s++)h=u[s],h.tag===n&&(r||(r=h));if(r)return this.mergeWith(r.data);throw new Error("No snapshot found with tag "+n)}throw new TypeError("Don't know what to do with "+n)},n.prototype.mergeWith=function(n){var r,o;return o=this,r=t.Helpers.Collection.getSettings(this.collection),e.Util.forEach(r.fields,function(e,r){var i,l;if(i=n[r]){if(e.embedded_element)return t.Helpers.Field.handleEmbeddedElement(o,n,r,e);if(e.embedded_collection)return t.Helpers.Field.handleEmbeddedCollection(o,n,r,e);if(l=o.fields[r],e.selector&&l!==i&&l&&i)throw new Error("Selector has changed from "+l+" to "+i);return o.setField(r,i,!0)}}),this},n.prototype.isPersisted=function(){var e,n,r,o;if(this.isNew())return!1;e=this.snapshots.getLastPersisted().data,r=t.Helpers.Element.getFields(this);for(n in r)if(o=r[n],e[n]!==o)return!1;return!0},n}(),e.Collection=function(){function n(n,r){var o,i,l,s,a;this.scheme=n,this.name=r,l=this,this.elements={},this.new_elements=[],this.default_pre_element={},this.selector_name=null,a=t.Helpers.Collection.getSettings(this),s=a.fields;for(o in s)i=s[o],i.selector&&(this.selector_name=o),i["default"]&&(this.default_pre_element[o]=i["default"]);this.actions={doGetAll:function(e){return t.Helpers.Collection.doGetAllAction(l,e)},doGetOne:function(e,n){return t.Helpers.Collection.doGetOneAction(l,e,n)}},e.Util.forEach(a.collection_actions,function(n,r){return l.actions["do"+e.Util.upperCamelize(r)]=function(e){return t.Helpers.Collection.doCustomAction(l,r,n,e)}})}return n.prototype.handlePreloadedElements=function(){var e,t,n,r,o,i,l,s,a,c,u,h,f;for(t=document.querySelectorAll('meta[name=httpong-collection][collection="'+this.name+'"][scheme="'+this.scheme.getName()+'"]'),r=document.querySelectorAll('meta[name=httpong-element][collection="'+this.name+'"][scheme="'+this.scheme.getName()+'"]'),o=0,l=t.length;o<l;o++)for(e=t[o],h=JSON.parse(e.content),i=0,s=h.length;i<s;i++)u=h[i],this.makeOrMerge(u);for(f=[],c=0,a=r.length;c<a;c++)n=r[c],f.push(this.makeOrMerge(JSON.parse(n.content)));return f},n.prototype.getName=function(){return this.name},n.prototype.getPluralName=n.prototype.getName,n.prototype.getSingularName=function(){return t.Helpers.Collection.getSingularName(this)},n.prototype.getScheme=function(){return this.scheme},n.prototype.getArray=function(e){var t;return null==e&&(e={without_new:!1}),t=e.without_new?[]:this.new_elements,t.concat(Object.values(this.elements))},n.prototype.find=function(e){return this.elements[e]},n.prototype.findBy=function(t,n,r){var o,i,l,s,a,c,u,h,f,p,m,g,d;if(null==r&&(r={without_new:!1,multiple:!1}),e.Util.isString(t)){if(o=this.getArray(r),r.multiple){for(d=[],s=0,c=o.length;s<c;s++)i=o[s],i.getField(t,!0)===n&&d.push(i);return d}for(a=0,u=o.length;a<u;a++)if(i=o[a],i.getField(t,!0)===n)return i}else{if(g=t,r=n||{without_new:!1,multiple:!1},o=this.getArray(r),r.multiple){for(d=[],p=0,h=o.length;p<h;p++){i=o[p],l=!0;for(t in g)if(n=g[t],i.getField(t,!0)!==n){l=!1;break}l&&d.push(i)}return d}for(m=0,f=o.length;m<f;m++){i=o[m],l=!0;for(t in g)if(n=g[t],i.getField(t,!0)!==n){l=!1;break}if(l)return i}}},n.prototype.makeNewElement=function(t){var n;return null==t&&(t=this.default_pre_element),n=new e.Element(this,t),this.addElement(n),n},n.prototype.addElement=function(e){return e.getSelectorValue()?this.elements[e.getSelectorValue()]=e:this.new_elements.push(e)},n.prototype.makeOrMerge=function(e){var t,n;return(n=e[this.selector_name])&&(t=this.find(n))?t.mergeWith(e):this.makeNewElement(e)},n}(),Object.values||(Object.values=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&e.propertyIsEnumerable(n)&&t.push(e[n]);return t}),(r=Array.prototype).includes||(r.includes=function(e){return this.indexOf(e)>-1}),(o=String.prototype).includes||(o.includes=function(e){return this.indexOf(e)>-1}),e.Util={BREAK:new Object,kebab:function(e){return e.toLowerCase().replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,"").replace(/(é|ë)/g,"e").split(" ").join("-")},unkebab:function(e){return e.split("-").join(" ")},unsnake:function(e){return e.split("_").join(" ")},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},camelize:function(e){return e.replace(/_/g," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return 0===t?e.toLowerCase():e.toUpperCase()}).replace(/\s+/g,"")},upperCamelize:function(e){return e.replace(/_/g," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return e.toUpperCase()}).replace(/\s+/g,"")},arrayDiff:function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},removeFromArray:function(e,t){var n;return n=e.indexOf(t),n!==-1&&(e.splice(n,n+1),!0)},copy:function(e){var t,n;if(null===e||"object"!=typeof e)return e;n=e.constructor();for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n},merge:function(e,t){var n;for(n in t)e[n]=t[n];return e},isInteger:function(e){return e===parseInt(e,10)},isNumber:function(e){return isFinite(e)&&!isNaN(parseFloat(e))},isString:function(e){return"string"==typeof e},isRegex:function(e){return e instanceof RegExp},forEach:function(t,n){var r,o;for(r in t)if(o=t[r],t.hasOwnProperty(r)&&n(o,r)===e.Util.BREAK)break},reverseForIn:function(t,n){var r,o,i,l,s;o=[],r=!1;for(l in t)o.push(l);for(i=o.length-1;i>=0&&!r;)s=n.call(t,o[i],t[o[i]]),s===e.Util.BREAK&&(r=!0),i--},endsWith:function(e,t){return e.endsWith?e.endsWith(t):e.substr(-t.length)===t},startsWith:function(e,t){return e.startsWith?e.startsWith(t):e.substr(0,t.length)===t}},t.Helpers={Url:{createForElement:function(e,n,r,o){var i,l,s,a,c;if(l=r.getCollection(),a=l.getScheme(),i=a.getApiUrl(),!i)throw new Error("Api url has not yet been set");return o.path?(s=t.Helpers.Url.trimSlashes(o.path),c=i+"/"+s):(c=i+"/"+l.getName(),n.without_selector||"POST"===e||(c=c+"/"+r.getSelectorValue())),n.method&&(c=c+"/"+(n.path||e)),o.suffix&&(c=c+"/"+o.suffix),c},createForCollection:function(e,t,n){var r;return r=t.getScheme().getApiUrl()+"/"+t.getName(),n.suffix&&(r=r+"/"+n.suffix),r},trimSlashes:function(e){return e.replace(/\/$/,"").replace(/^\//,"")}},Element:{toData:function(e){var n,r,o;return n=e.getCollection(),o=t.Helpers.Element.getFields(e),r=o},getFields:function(e){var t,n,r,o,i,l,s;t=e.getCollection(),s=t.getScheme(),i={},l=s.data.collections[t.getName()].fields;for(n in l)r=l[n],r.only_receive||r.embedded_collection||r.embedded_element||(o=e.getField(n),i[n]=o);return i}},Collection:{getSettings:function(e){return e.getScheme().data.collections[e.getName()]},getSingularName:function(e){return t.Helpers.Collection.getSettings(e).singular}},Field:{}},t.Helpers.Snapshot={getSortedArray:function(e){var t;return t=Object.values(e),t.sort(function(e,t){return e.time-t.time}),t},removeAfter:function(e,n){var r,o,i,l,s;for(r=t.Helpers.Snapshot.getSortedArray(n),l={},o=0,i=r.length;o<i;o++)s=r[o],s.time<=e&&(l[s.time]=s);return l}},t.Helpers.Collection.doGetAllAction=function(e,n){var r,o,l;return null==n&&(n={}),r=n.data,o=i("GET",t.Helpers.Url.createForCollection("GET",e,n),r,n.headers),l=t.http_function(o),l.then(function(t){var n,r,o,i,l;for(i=t.data,l=[],n=0,r=i.length;n<r;n++)o=i[n],l.push(e.makeOrMerge(o));return l}),l},t.Helpers.Collection.doGetOneAction=function(e,n,r){var o,l,s;return null==r&&(r={}),o=r.data,l=i("GET",t.Helpers.Url.createForCollection("GET",e,{suffix:n}),o,r.headers),s=t.http_function(l),s.then(function(t){return e.makeOrMerge(t.data)}),s},t.Helpers.Collection.doCustomAction=function(e,n,r,o){var l,s,a;return null==o&&(o={}),s=r.method.toUpperCase(),l=o.data,a=i(s,t.Helpers.Url.createForCollection("GET",e,{suffix:r.path||n}),l,o.headers),t.http_function(a)},t.Helpers.Field.handleEmbeddedCollection=function(t,n,r,o){var i,l,s,a;if(s=n[r],s||o.required)return i=t.getCollection(),a=i.getScheme(),l=a.getCollection(r||o.collection),e.Util.forEach(s,function(t){var n;return n=new e.Element(l,t),l.addElement(n)})},t.Helpers.Field.handleEmbeddedElement=function(e,t,n,r){var o,i,l,s,a,c;if(a=t[n],a||r.required)return i=e.getCollection(),c=i.getScheme(),s=r.collection?c.getCollection(r.collection):c.getCollectionBySingularName(n),l=s.makeOrMerge(a),o=r.associated_field||n+"_"+s.selector_name,e.setField(o,l.getSelectorValue())},t.Helpers.Element.setupBelongsToRelation=function(n,r,o){var i,l,s,a,c;return i=n.getCollection(),o.polymorphic||(c=o.collection?i.getScheme().getCollection(o.collection):i.getScheme().getCollectionBySingularName(r)),o.polymorphic?(l=o.collection_field||r+"_collection",s=o.collection_selector_field,a=o.field,n.relations["get"+e.Util.upperCamelize(r)]=function(){return t.Helpers.Element.getPolymorphicBelongsToElement(n,a,l,s,r)}):(a=o.field||r+"_"+c.selector_name,n.relations["get"+e.Util.upperCamelize(r)]=function(){return t.Helpers.Element.getBelongsToElement(n,c,a)})},t.Helpers.Element.getBelongsToElement=function(e,t,n){var r;return r=e.getField(n,!0,"belongs_to"),t.find(r)||null},t.Helpers.Element.getPolymorphicBelongsToElement=function(e,t,n,r,o){var i,l,s;return l=e.getField(n,!0,"belongs_to_collection"),i=e.getCollection().getScheme().getCollection(l),t||(r||(r=i.selector_name),t=o+"_"+r),s=e.getField(t,!0,"belongs_to"),i.find(s)||null},t.Helpers.Element.setupHasManyRelation=function(n,r,o){var i,l,s,a,c;return i=n.getCollection(),l=t.Helpers.Collection.getSettings(n.getCollection()),a=i.getScheme().getCollection(o.collection||r),s=o.references_field||r+"_"+a.selector_name+"s",(c=l.fields[s])?n.relations["get"+e.Util.upperCamelize(r)]=function(){return t.Helpers.Element.getHasManyRelationArrayThroughReferencesField(n,a,field_name)}:n.relations["get"+e.Util.upperCamelize(r)]=t.Helpers.Element.getHasManyRelationFunction(n,i,o,a)},t.Helpers.Element.getHasManyRelationFunction=function(e,n,r,o){var i,l,s,a;return i=n.getSingularName(),a=t.Helpers.Collection.getSettings(o),r.polymorphic?(s=r.as+"_"+n.selector_name,l=r.as+"_collection",function(){return t.Helpers.Element.getPolymorphicHasManyRelationArray(e,o,s,l)}):(s=r.field?r.field:r.as?r.as+"_"+n.selector_name:i+"_"+n.selector_name,function(){return t.Helpers.Element.getHasManyRelationArray(e,o,s)})},t.Helpers.Element.getHasManyRelationArray=function(e,t,n){var r,o,i,l,s,a;for(o=[],a=e.getSelectorValue(),s=t.getArray(),i=0,l=s.length;i<l;i++)r=s[i],a===r.getField(n,!0,"has_many")&&o.push(r);return o},t.Helpers.Element.getPolymorphicHasManyRelationArray=function(e,t,n,r){var o,i,l,s,a,c,u;for(l=[],u=e.getSelectorValue(),o=e.getCollection().getName(),c=t.getArray(),s=0,a=c.length;s<a;s++)i=c[s],u===i.getField(n,!0,"has_many")&&o===i.getField(r,!0,"has_many_collection_name")&&l.push(i);return l},t.Helpers.Element.getHasManyRelationArrayThroughReferencesField=function(e,t,n){var r,o,i,l,s,a;if(a=e.getField(n,!0,"has_many_array"),!Array.isArray(a))throw new Error("Field "+n+" is not an array, but it should be an array of references to "+t.getName());for(o=[],s=t.getArray(),i=0,l=s.length;i<l;i++)r=s[i],a.includes(e.getSelectorValue())&&o.push(r);return o},t.Helpers.Element.setupHasOneRelation=function(n,r,o){var i,l,s,a;return i=n.getCollection(),l=t.Helpers.Collection.getSettings(n.getCollection()),a=i.getScheme(),s=o.collection?a.getCollection(o.collection):a.getCollectionBySingularName(r),n.relations["get"+e.Util.upperCamelize(r)]=function(){return t.Helpers.Element.getHasManyRelationFunction(n,i,o,s)()[0]}},i=function(e,t,n,r){return null==r&&(r={}),r.Accept=r["Content-Type"]="application/json",{method:e,url:t,data:JSON.stringify(n||{}),headers:r,dataType:"json",responseType:"json"}},t.Helpers.Element.doAction=function(n,r,o){var l,s,a;if(null==o&&(o={}),n.snapshots.make("before_"+r.toLowerCase()),o.data?l=o.data:"GET"!==r&&(l=t.Helpers.Element.toData(n)),"POST"===r){if(!n.isNew())throw new Error("Element is not new")}else if(n.isNew())throw new Error("Element is new");return s=i(r,t.Helpers.Url.createForElement(r,{},n,o),l,o.headers),a=t.http_function(s),a.then(function(t){var o;if(t.data&&n.mergeWith(t.data),n.snapshots.make("after_"+r.toLowerCase()),o=n.getCollection(),o.new_elements.includes(n))return e.Util.removeFromArray(o.new_elements,n),o.elements[n.getSelectorValue()]=n}),a},t.Helpers.Element.doCustomAction=function(n,r,o,l){var s,a,c,u;return null==l&&(l={}),a=o.method.toUpperCase(),n.snapshots.make("before_"+a.toLowerCase()),l.data?s=l.data:o.without_data||(s=t.Helpers.Element.toData(n)),c=i(a,t.Helpers.Url.createForElement(r,o,n,l),s,l.headers),u=t.http_function(c),u.then(function(t){var r,i;if(o.returns_other||(t.data&&n.mergeWith(t.data),n.snapshots.make("after_"+a.toLowerCase())),r=n.getCollection(),(i=n.getSelectorValue())&&r.new_elements.includes(n))return e.Util.removeFromArray(r.new_elements,n),r.elements[i]=n}),u},n});