var HP,HPP,HTTPong,base,base1,base2,getOptions;HTTPong=window.HTTPong=HP={},HP["private"]=HPP={log:function(){return console.log.apply(console,["%c HP ","background: #80CBC4; color: #fff"].concat(Array.from(arguments)))},schemes:{},http_function:null,type_tests:[],isHpe:function(e){return e.constructor===HP.Element},isHpc:function(e){return e.constructor===HP.Collection}},HP.addScheme=function(e){var t;if(t=new HP.Scheme(e),HPP.schemes[t.getName()])throw new Error("A scheme with name "+t.getName()+" already exists");return HPP.schemes[t.getName()]=t},HP.getScheme=function(e){return HPP.schemes[e]},HP.initialize=function(e){var t,n,o,r;if(null==e&&(e={no_search:!1}),!e.no_search){if(r=document.querySelectorAll("meta[name=httpong-scheme]"),!r.length&&!Object.keys(HP.schemes).length)throw new Error("No scheme added or found");for(t=0,n=r.length;t<n;t++)o=r[t],HP.addScheme(JSON.parse(o.content))}return HP},HP.setHttpFunction=function(e){return HPP.http_function=e},HP.addTypeTest=function(e,t){return HPP.type_tests[e]=t},HP.Scheme=function(){function e(e,t){null==t&&(t={no_normalize:!1,no_create_collections:!1}),this.data=e,this.collections={},this.location=null,t.no_normalize||this.normalize(),t.no_create_collections||this.createCollections()}return e.prototype.getName=function(){return this.data.name},e.prototype.normalize=function(){var e,t,n,o,r,i,l;this.data.name=this.data.name.toLowerCase(),i=this.data.collections,l=[];for(o in i)r=i[o],r.singular||(r.singular=o.slice(0,-1)),r.actions||(r.actions={}),r.collection_actions||(r.collection_actions={}),r.relations||(r.relations={}),(e=r.relations).has_one||(e.has_one={}),(t=r.relations).has_many||(t.has_many={}),l.push((n=r.relations).belongs_to||(n.belongs_to={}));return l},e.prototype.createCollections=function(){var e,t,n,o,r;o=this.data.collections,r=[];for(t in o)n=o[t],this.collections[t]?HPP.log("Collection with name "+t+" already exists in scheme"):(e=new HP.Collection(this,t),r.push(this.collections[t]=e));return r},e.prototype.getCollection=function(e){if(this.collections[e])return this.collections[e];throw new Error("Collection "+e+" does not exist")},e.prototype.getCollectionBySingularName=function(e){var t,n,o;o=this.collections;for(n in o)if(t=o[n],t.getSingularName()===e)return t;throw new Error("Collection "+e+" does not exist")},e.prototype.select=e.prototype.getCollection,e.prototype.setApiUrl=function(e){var t;return t=document.createElement("a"),t.href=e,this.location={is_other_domain:t.host!==window.location.host,protocol:t.protocol,host:t.host,path:HP.Helpers.Url.trimSlashes(t.pathname)}},e.prototype.getApiUrl=function(){return this.location.is_other_domain?this.location.protocol+"//"+this.location.host+"/"+this.location.path:"/"+this.location.path},e}(),HP.Element=function(){function e(e,t){var n,o;this.collection=e,o=this,this.fields={},this.relations={},this.snapshots={},this.last_snapshot_time=null,n=HP.Helpers.Collection.getSettings(this.collection),HP.Util.forEach(n.fields,function(e,n){var r;if(e.embedded_element)return HP.Helpers.Field.handleEmbeddedElement(o,t,n,e);if(e.embedded_collection)return HP.Helpers.Field.handleEmbeddedCollection(o,t,n,e);if(!e.only_send)return r=t[n],HP.Helpers.Field.validateType(n,r,e),o.setField(n,r,!0)}),HP.Util.forEach(n.relations.has_many,function(e,t){return HP.Helpers.Element.setupHasManyRelation(o,t,e)}),HP.Util.forEach(n.relations.has_one,function(e,t){return HP.Helpers.Element.setupHasOneRelation(o,t,e)}),HP.Util.forEach(n.relations.belongs_to,function(e,t){return HP.Helpers.Element.setupBelongsToRelation(o,t,e)}),this.actions={doGet:function(e){if(o.isNew())throw new Error("Element is new");return HP.Helpers.Element.doAction(o,"GET",e)},doPost:function(e){if(!o.isNew())throw new Error("Element is not new");return HP.Helpers.Element.doAction(o,"POST",e)},doPut:function(e){if(o.isNew())throw new Error("Element is new");return HP.Helpers.Element.doAction(o,"PUT",e)},doDelete:function(e){if(o.isNew())throw new Error("Element is new");return HP.Helpers.Element.doAction(o,"DELETE",e)}},HP.Util.forEach(n.actions,function(e,t){return o.actions["do"+HP.Util.upperCamelize(t)]=function(n){if(o.isNew())throw new Error("Element is new");return HP.Helpers.Element.doCustomAction(o,t,e,n)}}),this.makeSnapshot("creation")}return e.prototype.getCollection=function(){return this.collection},e.prototype.getCollectionName=function(){return this.collection.getName()},e.prototype.getSelectorValue=function(){return this.fields[this.collection.selector_name]},e.prototype.makeSnapshot=function(e){var t,n,o;return t=Date.now(),n=this,this.snapshots=HP.Helpers.Snapshot.removeAfter(this.last_snapshot_time,this.snapshots),this.snapshots[t]?this.makeSnapshot(e):(o=this.snapshots[t]={tag:e,time:t,data:HP.Helpers.Element.getFields(this),revert:function(){return n.undo(t)}},this.last_snapshot_time=t,o)},e.prototype.getField=function(e){return this.fields[e]},e.prototype.setField=function(e,t){return this.fields[e]=t,this},e.prototype.remove=function(){var e;return e=this,this.isNew()?(HPP.Util.removeFromArray(this.getCollection().new_elements,this),{then:function(e){return e()},"catch":function(){}}):this.actions.doDelete().then(function(){var t;return t=e.getCollection().elements,delete t[e.getSelectorValue()]})},e.prototype.isNew=function(){if(this.getCollection().new_elements.includes(this)){if(this.getSelectorValue())throw new Error("Element has a selector value but is in new_elements array");return!0}if(this.getSelectorValue())return!1;throw new Error("Element has no selector value but is in elements object")},e.prototype.undo=function(e){var t,n,o,r,i;if(null==e&&(e=0),HP.Util.isInteger(e)){if(e>1e6){if(this.snapshots[e])return this.mergeWith(this.snapshots[e].data),this.last_snapshot_time=e;throw new Error("Diff at time "+e+" does not exist")}if(e<0)throw new Error(e+" is smaller than 0");return o=HP.Helpers.Snapshot.getSortedArray(this.snapshots),i=o.length,r=o.indexOf(this.snapshots[this.last_snapshot_time]),n=o[r-e],this.mergeWith(n.data),this.last_snapshot_time=n.time}if(HP.Util.isString(e)){if(t=null,HP.Util.reverseForIn(this.snapshots,function(n,o){if("last"!==n)return o.tag===e?t||(t=o):void 0}),t)return this.mergeWith(t.data);throw new Error("No snapshot found with tag "+e)}throw new TypeError("Don't know what to do with "+e)},e.prototype.mergeWith=function(e){var t,n;return n=this,t=HP.Helpers.Collection.getSettings(this.collection),HP.Util.forEach(t.fields,function(t,o){var r,i;if(r=e[o])if(t.embedded_element);else if(!t.embedded_collection){if(i=n.fields[o],t.selector&&i!==r&&i&&r)throw new Error("Selector has changed from "+i+" to "+r);return HP.Helpers.Field.validateType(o,r,t),n.setField(o,r,!0)}})},e}(),HP.Collection=function(){function e(e,t){var n,o,r,i,l;this.scheme=e,this.name=t,r=this,this.elements={},this.new_elements=[],this.default_pre_element={},this.selector_name=null,l=HP.Helpers.Collection.getSettings(this),i=l.fields;for(n in i)o=i[n],o.selector&&(this.selector_name=n),o["default"]&&(this.default_pre_element[n]=o["default"]);this.actions={doGetAll:function(e){return HP.Helpers.Collection.doGetAllAction(r,e)},doGetOne:function(e,t){return HP.Helpers.Collection.doGetOneAction(r,e,t)}}}return e.prototype.getName=function(){return this.name},e.prototype.getPluralName=e.prototype.getName,e.prototype.getSingularName=function(){return HP.Helpers.Collection.getSingularName(this)},e.prototype.getScheme=function(){return this.scheme},e.prototype.getArray=function(e){var t;return null==e&&(e={without_new:!1}),t=e.without_new?[]:this.new_elements,t.concat(Object.values(this.elements))},e.prototype.find=function(e){return this.elements[e]},e.prototype.findBy=function(e,t,n){var o,r,i,l;for(null==n&&(n={without_new:!1}),o=this.getArray(n),i=0,l=o.length;i<l;i++)if(r=o[i],r.getField(e,!0)===t)return r},e.prototype.makeNewElement=function(e){var t;return null==e&&(e=this.default_pre_element),t=new HP.Element(this,e),this.addElement(t),console.log(this),t},e.prototype.addElement=function(e){return e.getSelectorValue()?this.elements[e.getSelectorValue()]=e:this.new_elements.push(e)},e.prototype.makeOrMerge=function(e){var t,n;return(n=e[this.selector_name])&&(t=this.find(n))?t.ergeWith(e):this.makeNewElement(e)},e}(),Object.values||(Object.values=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&e.propertyIsEnumerable(n)&&t.push(e[n]);return t}),(base=String.prototype).endsWith||(base.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1}),(base1=Array.prototype).includes||(base1.includes=function(e){return this.indexOf(e)>-1}),(base2=String.prototype).includes||(base2.includes=function(e){return this.indexOf(e)>-1}),HP.Util={kebab:function(e){return e.toLowerCase().replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,"").replace(/(é|ë)/g,"e").split(" ").join("-")},unkebab:function(e){return e.split("-").join(" ")},unsnake:function(e){return e.split("_").join(" ")},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},camelize:function(e){return e.replace("_"," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return 0===t?e.toLowerCase():e.toUpperCase()}).replace(/\s+/g,"")},upperCamelize:function(e){return e.replace("_"," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return e.toUpperCase()}).replace(/\s+/g,"")},arrayDiff:function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},removeFromArray:function(e,t){var n;return n=e.indexOf(t),n!==-1&&(e.splice(n,n+1),!0)},copy:function(e){var t,n;if(null===e||"object"!=typeof e)return e;n=e.constructor();for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n},merge:function(e,t){var n,o;o=[];for(n in t)o.push(e[n]=t[n]);return o},isInteger:function(e){return e===parseInt(e,10)},isNumber:function(e){return isFinite(e)&&!isNaN(parseFloat(e))},isString:function(e){return"string"==typeof e},forEach:function(e,t){var n,o,r;o=[];for(n in e)r=e[n],e.hasOwnProperty(n)&&o.push(t(r,n));return o},isOfType:function(e,t){var n,o,r;switch(e.toLowerCase()){case"array":return Array.isArray(t);case"string":return HP.Util.isString(t);case"integer":return HP.Util.isInteger(t);case"number":return HP.Util.isNumber(t);default:r=HPP.type_tests;for(o in r)if(n=r[o],e===o)return n(t);throw new Error("Type "+e+" not found")}},reverseForIn:function(e,t){var n,o,r;n=[];for(r in e)n.push(r);for(o=n.length-1;o>=0;)t.call(e,n[o],e[n[o]]),o--}},HP.Helpers={Url:{createForElement:function(e,t,n,o){var r,i,l,s,a;if(i=n.getCollection(),s=i.getScheme(),r=s.getApiUrl(),!r)throw new Error("Api url has not yet been set");return o.path?(l=HP.Helpers.Url.trimSlashes(o.path),a=r+"/"+l):(a=r+"/"+i.getName(),t.without_selector||"POST"===e||(a=a+"/"+n.getSelectorValue())),t.method&&(a=a+"/"+e),o.suffix&&(a=a+"/"+o.suffix),a},createForCollection:function(e,t,n){var o;return o=t.getScheme().getApiUrl()+"/"+t.getName(),n.suffix&&(o=o+"/"+n.suffix),o},trimSlashes:function(e){return e.replace(/\/$/,"").replace(/^\//,"")}},Element:{toData:function(e){var t,n,o;return t=e.getCollection(),o=HP.Helpers.Element.getFields(e),n={},n[HP.Helpers.Collection.getSingularName(t)]=o,n},getFields:function(e){var t,n,o,r,i,l,s;t=e.getCollection(),s=t.getScheme(),i={},l=s.data.collections[t.getName()].fields;for(n in l)o=l[n],o.only_receive||o.embedded_collection||o.embedded_element||(r=e.getField(n),HP.Helpers.Field.validateType(n,r,o),i[n]=r);return i}},Collection:{getSettings:function(e){return e.getScheme().data.collections[e.getName()]},getSingularName:function(e){return HP.Helpers.Collection.getSettings(e).singular}},Field:{validateType:function(e,t,n){var o,r,i,l,s;if(void 0===t||null===t){if(void 0===t&&(n.not_undefined||n.not_nothing))throw new Error("The value of field "+e+" is undefined, and it should not be");if(null===t&&(n.not_null||n.not_nothing))throw new Error("The value of field "+e+" is null, and it should not be")}else if(n.type){if(!HP.Util.isOfType(n.type,t))throw HPP.log("Error value: ",t),new Error("The value of field "+e+" (value above) is not a "+n.type)}else if(n.types){for(o=!1,l=n.types,r=0,i=l.length;r<i;r++)if(s=l[r],HP.Helpers.Field.isOfType(s,t)){o=!0;break}if(HPP.log("Error value: ",t),!o)throw new Error("The value of field "+e+" (value above) is not of any of these: "+n.types)}}}},HP.Helpers.Snapshot={getSortedArray:function(e){var t;return t=Object.values(e),t.sort(function(e,t){return e.time-t.time}),t},removeAfter:function(e,t){var n,o,r,i,l;for(n=HP.Helpers.Snapshot.getSortedArray(t),i={},o=0,r=n.length;o<r;o++)l=n[o],l.time<=e&&(i[l.time]=l);return i}},HP.Helpers.Collection.doGetAllAction=function(e,t){var n,o,r,i;return null==t&&(t={}),n=t.data,i=HP.Helpers.Url.createForCollection("GET",e,t),o={method:"GET",url:i,data:n,headers:t.headers,dataType:"json",responseType:"json"},r=HPP.http_function(o),r.then(function(t){var n,o,r,i,l;for(i=t.data,l=[],n=0,o=i.length;n<o;n++)r=i[n],l.push(e.makeOrMerge(r));return l}),r},HP.Helpers.Collection.doGetOneAction=function(e,t,n){var o,r,i,l;return null==n&&(n={}),o=n.data,l=HP.Helpers.Url.createForCollection("GET",e,{suffix:t}),r={method:"GET",url:l,data:o,headers:n.headers,dataType:"json",responseType:"json"},i=HPP.http_function(r),i.then(function(t){return e.makeOrMerge(t.data)}),i},HP.Helpers.Element.setupBelongsToRelation=function(e,t,n){var o,r,i,l;return o=e.getCollection(),n.polymorphic||(l=n.collection?o.getScheme().getCollection(n.collection):o.getScheme().getCollectionBySingularName(t)),i=n.field||t+"_"+(n.polymorphic?n.collection_selector_field:l.selector_name),n.polymorphic?(r=n.collection_field||t+"_collection",e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HP.Helpers.Element.getPolymorphicBelongsToElement(e,i,r)}):e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HP.Helpers.Element.getBelongsToElement(e,l,i)}},HP.Helpers.Element.getBelongsToElement=function(e,t,n){var o;return o=e.getField(n,!0,"belongs_to"),t.find(o)||null},HP.Helpers.Element.getPolymorphicBelongsToElement=function(e,t,n){var o,r;return o=e.getField(n,!0,"belongs_to_collection"),r=e.getField(t,!0,"belongs_to"),e.getCollection().getScheme().getCollection(o).find(r)||null},HP.Helpers.Element.setupHasManyRelation=function(e,t,n){var o,r,i,l,s,a,c,u,h;return o=e.getCollection(),r=HP.Helpers.Collection.getSettings(e.getCollection()),c=o.getScheme().getCollection(n.collection||t),a=n.references_field||t+"_"+c.selector_name+"s",(h=r.fields[a])?e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HP.Helpers.Element.getHasManyRelationArrayThroughReferencesField(e,c,field_name)}:(i=o.getSingularName(),u=HP.Helpers.Collection.getSettings(c),n.polymorphic?(s=n.as+"_"+o.selector_name,l=n.as+"_collection",e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HP.Helpers.Element.getPolymorphicHasManyRelationArray(e,c,s,l)}):(s=n.field?n.field:n.as?n.as+"_"+o.selector_name:i+"_"+o.selector_name,e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HP.Helpers.Element.getHasManyRelationArray(e,c,s)}))},HP.Helpers.Element.getHasManyRelationArray=function(e,t,n){var o,r,i,l,s,a;for(r=[],a=e.getSelectorValue(),s=t.getArray(),i=0,l=s.length;i<l;i++)o=s[i],a===o.getField(n,!0,"has_many")&&r.push(o);return r},HP.Helpers.Element.getPolymorphicHasManyRelationArray=function(e,t,n,o){var r,i,l,s,a,c,u;for(l=[],u=e.getSelectorValue(),r=e.getCollection().getName(),c=t.getArray(),s=0,a=c.length;s<a;s++)i=c[s],u===i.getField(n,!0,"has_many")&&r===i.getField(o,!0,"has_many_collection_name")&&l.push(i);return l},HP.Helpers.Element.getHasManyRelationArrayThroughReferencesField=function(e,t,n){var o,r,i,l,s,a;if(a=e.getField(n,!0,"has_many_array"),!Array.isArray(a))throw new Error("Field "+n+" is not an array, but it should be an array of references to "+t.getName());for(r=[],s=t.getArray(),i=0,l=s.length;i<l;i++)o=s[i],a.includes(e.getSelectorValue())&&r.push(o);return r},HP.Helpers.Element.setupHasOneRelation=function(e,t,n){return console.warn("Not yet implemented")},HP.Helpers.Element.getHasOneElement=function(e,t,n){},getOptions=function(e,t,n,o){return{method:e,url:t,data:n,headers:o,dataType:"json",responseType:"json"}},HP.Helpers.Element.doAction=function(e,t,n){var o,r,i;return null==n&&(n={}),e.makeSnapshot("before_"+t.toLowerCase()),n.data?o=n.data:"GET"!==t&&(o=HP.Helpers.Element.toData(e)),r=getOptions(t,HP.Helpers.Url.createForElement(t,{},e,n),o,n.headers),i=HPP.http_function(r),i.then(function(n){return n.data&&e.mergeWith(n.data),e.makeSnapshot("after_"+t.toLowerCase())}),i},HP.Helpers.Element.doCustomAction=function(e,t,n,o){var r,i,l,s;return null==o&&(o={}),i=n.method.toUpperCase(),e.makeSnapshot("before_"+i.toLowerCase()),o.data?r=o.data:o.exclude_data||n.exclude_data||(r=HP.Helpers.Element.toData(e)),l=getOptions(i,HP.Helpers.Url.createForElement(t,n,e,o),r,o.headers),s=HPP.http_function(l),s.then(function(t){return t.data&&e.mergeWith(t.data),e.makeSnapshot("after_"+i.toLowerCase())}),s},HP.Helpers.Field.handleEmbeddedCollection=function(e,t,n,o){var r,i,l;return r=e.getCollection(),l=r.getScheme(),i=l.getCollection(n||o.collection),HP.Util.forEach(t[n],function(e){var t;return t=new HP.Element(i,e),i.addElement(t)})},HP.Helpers.Field.handleEmbeddedElement=function(e,t,n,o){var r,i,l,s,a;return i=e.getCollection(),a=i.getScheme(),s=o.collection?a.getCollection(o.collection):a.getCollectionBySingularName(n),l=new HP.Element(s,t[n]),s.addElement(l),r=o.associated_field||n+"_"+s.selector_name,e.setField(r,l.getSelectorValue())};