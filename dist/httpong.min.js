var HP,HPP,HTTPong,base,base1,base2,getOptions;HTTPong=window.HTTPong=HP={},HP["private"]=HPP={log:function(){return console.log.apply(console,["%c HTTPong ","background: #80CBC4; color: #fff"].concat(Array.from(arguments)))},schemes:{},http_function:null,isHpe:function(e){return e.constructor===HP.Element},isHpc:function(e){return e.constructor===HP.Collection}},HP.addScheme=function(e){var t;if(t=new HP.Scheme(e),HPP.schemes[t.getName()])throw new Error("A scheme with name "+t.getName()+" already exists");return HPP.schemes[t.getName()]=t},HP.getScheme=function(e){return HPP.schemes[e]},HP.initialize=function(){var e,t,n,o,r,l,i,s,a,c;if(c=document.querySelectorAll("meta[name=httpong-scheme]"),!c.length&&!Object.keys(HPP.schemes).length)throw new Error("No scheme added or found");for(n=0,o=c.length;n<o;n++)a=c[n],HP.addScheme(JSON.parse(a.content));r=HPP.schemes;for(s in r){i=r[s],l=i.collections;for(t in l)e=l[t],e.handlePreloadedElements()}return HP},HP.setHttpFunction=function(e){return HPP.http_function=e},HP.Scheme=function(){function e(e,t){null==t&&(t={no_normalize:!1,no_create_collections:!1}),this.data=e,this.collections={},this.location=null,t.no_normalize||this.normalize(),t.no_create_collections||this.createCollections()}return e.prototype.getName=function(){return this.data.name},e.prototype.normalize=function(){var e,t,n,o,r,l,i;this.data.name=this.data.name.toLowerCase(),l=this.data.collections,i=[];for(o in l)r=l[o],r.singular||(r.singular=o.slice(0,-1)),r.actions||(r.actions={}),r.collection_actions||(r.collection_actions={}),r.relations||(r.relations={}),(e=r.relations).has_one||(e.has_one={}),(t=r.relations).has_many||(t.has_many={}),i.push((n=r.relations).belongs_to||(n.belongs_to={}));return i},e.prototype.createCollections=function(){var e,t,n,o,r;o=this.data.collections,r=[];for(t in o)n=o[t],this.collections[t]?HPP.log("Collection with name "+t+" already exists in scheme"):(e=new HP.Collection(this,t),r.push(this.collections[t]=e));return r},e.prototype.getCollection=function(e){if(this.collections[e])return this.collections[e];throw new Error("Collection "+e+" does not exist")},e.prototype.getCollectionBySingularName=function(e){var t,n,o;o=this.collections;for(n in o)if(t=o[n],t.getSingularName()===e)return t;throw new Error("Collection "+e+" does not exist")},e.prototype.select=e.prototype.getCollection,e.prototype.setApiUrl=function(e){var t;return t=document.createElement("a"),t.href=e,this.location={is_other_domain:t.host!==window.location.host,protocol:t.protocol,host:t.host,path:HPP.Helpers.Url.trimSlashes(t.pathname)}},e.prototype.getApiUrl=function(){return this.location.is_other_domain?this.location.protocol+"//"+this.location.host+"/"+this.location.path:"/"+this.location.path},e}(),HP.Element=function(){function e(e,t){var n,o;this.collection=e,o=this,this.fields={},this.relations={},this.snapshots={},this.last_snapshot_time=null,n=HPP.Helpers.Collection.getSettings(this.collection),HP.Util.forEach(n.fields,function(e,n){var r;if(e.embedded_element)return HPP.Helpers.Field.handleEmbeddedElement(o,t,n,e);if(e.embedded_collection)return HPP.Helpers.Field.handleEmbeddedCollection(o,t,n,e);if(!e.only_send)return r=t[n],o.setField(n,r,!0)}),HP.Util.forEach(n.relations.has_many,function(e,t){return HPP.Helpers.Element.setupHasManyRelation(o,t,e)}),HP.Util.forEach(n.relations.has_one,function(e,t){return HPP.Helpers.Element.setupHasOneRelation(o,t,e)}),HP.Util.forEach(n.relations.belongs_to,function(e,t){return HPP.Helpers.Element.setupBelongsToRelation(o,t,e)}),this.actions={doGet:function(e){return HPP.Helpers.Element.doAction(o,"GET",e)},doPost:function(e){return HPP.Helpers.Element.doAction(o,"POST",e)},doPut:function(e){return HPP.Helpers.Element.doAction(o,"PUT",e)},doDelete:function(e){return HPP.Helpers.Element.doAction(o,"DELETE",e)}},HP.Util.forEach(n.actions,function(e,t){return o.actions["do"+HP.Util.upperCamelize(t)]=function(n){if(o.isNew()&&!e.without_selector)throw new Error("Element is new");return HPP.Helpers.Element.doCustomAction(o,t,e,n)}}),this.makeSnapshot("creation")}return e.prototype.getCollection=function(){return this.collection},e.prototype.getCollectionName=function(){return this.collection.getName()},e.prototype.getSelectorValue=function(){return this.fields[this.collection.selector_name]},e.prototype.makeSnapshot=function(e){var t,n,o;return t=Date.now(),n=this,this.snapshots=HPP.Helpers.Snapshot.removeAfter(this.last_snapshot_time,this.snapshots),this.snapshots[t]?this.makeSnapshot(e):(o=this.snapshots[t]={tag:e,time:t,data:HPP.Helpers.Element.getFields(this),revert:function(){return n.undo(t)}},this.last_snapshot_time=t,o)},e.prototype.getField=function(e){return this.fields[e]},e.prototype.setField=function(e,t){return this.fields[e]=t,this},e.prototype.remove=function(){var e;return e=this,this.isNew()?(HP.Util.removeFromArray(this.getCollection().new_elements,this),{then:function(e){return e()},"catch":function(){}}):this.actions.doDelete().then(function(){var t;return t=e.getCollection().elements,delete t[e.getSelectorValue()]})},e.prototype.save=function(){return this.isNew()?this.actions.doPost():this.actions.doPut()},e.prototype.isNew=function(){if(this.getCollection().new_elements.includes(this)){if(this.getSelectorValue())throw new Error("Element has a selector value but is in new_elements array");return!0}if(this.getSelectorValue())return!1;throw new Error("Element has no selector value but is in elements object")},e.prototype.undo=function(e){var t,n,o,r,l,i,s,a,c;if(null==e&&(e=0),HP.Util.isInteger(e)){if(e>1e6){if(this.snapshots[e])return this.mergeWith(this.snapshots[e].data),this.last_snapshot_time=e;throw new Error("Diff at time "+e+" does not exist")}if(e<0)throw new Error(e+" is smaller than 0");return o=HPP.Helpers.Snapshot.getSortedArray(this.snapshots),s=o.length,r=o.indexOf(this.snapshots[this.last_snapshot_time]),n=o[r-e],this.mergeWith(n.data),this.last_snapshot_time=n.time}if(HP.Util.isString(e)){for(t=null,a=HPP.Helpers.Snapshot.getSortedArray(this.snapshots),l=0,i=a.length;l<i;l++)c=a[l],c.tag===e&&(t||(t=c));if(t)return this.mergeWith(t.data);throw new Error("No snapshot found with tag "+e)}throw new TypeError("Don't know what to do with "+e)},e.prototype.mergeWith=function(e){var t,n;return n=this,t=HPP.Helpers.Collection.getSettings(this.collection),HP.Util.forEach(t.fields,function(t,o){var r,l;if(r=e[o])if(t.embedded_element);else if(!t.embedded_collection){if(l=n.fields[o],t.selector&&l!==r&&l&&r)throw new Error("Selector has changed from "+l+" to "+r);return n.setField(o,r,!0)}})},e.prototype.isPersisted=function(){var e,t,n,o,r;n=null,HP.Util.reverseForIn(this.snapshots,function(e,t){if(!n)return"after_post"===t.tag||"after_put"===t.tag||"after_get"===t.tag||"creation"===t.tag?n=t:void 0}),e=n.data,o=HPP.Helpers.Element.getFields(this);for(t in o)if(r=o[t],e[t]!==r)return!1;return!0},e}(),HP.Collection=function(){function e(e,t){var n,o,r,l,i;this.scheme=e,this.name=t,r=this,this.elements={},this.new_elements=[],this.default_pre_element={},this.selector_name=null,i=HPP.Helpers.Collection.getSettings(this),l=i.fields;for(n in l)o=l[n],o.selector&&(this.selector_name=n),o["default"]&&(this.default_pre_element[n]=o["default"]);this.actions={doGetAll:function(e){return HPP.Helpers.Collection.doGetAllAction(r,e)},doGetOne:function(e,t){return HPP.Helpers.Collection.doGetOneAction(r,e,t)}},HP.Util.forEach(i.collection_actions,function(e,t){return r.actions["do"+HP.Util.upperCamelize(t)]=function(n){return HPP.Helpers.Collection.doCustomAction(r,t,e,n)}})}return e.prototype.handlePreloadedElements=function(){var e,t,n,o,r,l,i,s,a,c,u,h,p;for(t=document.querySelectorAll('meta[name=httpong-collection][collection="'+this.name+'"][scheme="'+this.scheme.getName()+'"]'),o=document.querySelectorAll('meta[name=httpong-element][collection="'+this.name+'"][scheme="'+this.scheme.getName()+'"]'),r=0,i=t.length;r<i;r++)for(e=t[r],h=JSON.parse(e.content),l=0,s=h.length;l<s;l++)u=h[l],this.makeOrMerge(u);for(p=[],c=0,a=o.length;c<a;c++)n=o[c],p.push(this.makeOrMerge(JSON.parse(n.content)));return p},e.prototype.getName=function(){return this.name},e.prototype.getPluralName=e.prototype.getName,e.prototype.getSingularName=function(){return HPP.Helpers.Collection.getSingularName(this)},e.prototype.getScheme=function(){return this.scheme},e.prototype.getArray=function(e){var t;return null==e&&(e={without_new:!1}),t=e.without_new?[]:this.new_elements,t.concat(Object.values(this.elements))},e.prototype.find=function(e){return this.elements[e]},e.prototype.findBy=function(e,t,n){var o,r,l,i;for(null==n&&(n={without_new:!1}),o=this.getArray(n),l=0,i=o.length;l<i;l++)if(r=o[l],r.getField(e,!0)===t)return r},e.prototype.makeNewElement=function(e){var t;return null==e&&(e=this.default_pre_element),t=new HP.Element(this,e),this.addElement(t),t},e.prototype.addElement=function(e){return e.getSelectorValue()?this.elements[e.getSelectorValue()]=e:this.new_elements.push(e)},e.prototype.makeOrMerge=function(e){var t,n;return(n=e[this.selector_name])&&(t=this.find(n))?t.mergeWith(e):this.makeNewElement(e)},e}(),Object.values||(Object.values=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&e.propertyIsEnumerable(n)&&t.push(e[n]);return t}),(base=String.prototype).endsWith||(base.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1}),(base1=Array.prototype).includes||(base1.includes=function(e){return this.indexOf(e)>-1}),(base2=String.prototype).includes||(base2.includes=function(e){return this.indexOf(e)>-1}),HP.Util={kebab:function(e){return e.toLowerCase().replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,"").replace(/(é|ë)/g,"e").split(" ").join("-")},unkebab:function(e){return e.split("-").join(" ")},unsnake:function(e){return e.split("_").join(" ")},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},camelize:function(e){return e.replace("_"," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return 0===t?e.toLowerCase():e.toUpperCase()}).replace(/\s+/g,"")},upperCamelize:function(e){return e.replace("_"," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return e.toUpperCase()}).replace(/\s+/g,"")},arrayDiff:function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},removeFromArray:function(e,t){var n;return n=e.indexOf(t),n!==-1&&(e.splice(n,n+1),!0)},copy:function(e){var t,n;if(null===e||"object"!=typeof e)return e;n=e.constructor();for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n},merge:function(e,t){var n,o;o=[];for(n in t)o.push(e[n]=t[n]);return o},isInteger:function(e){return e===parseInt(e,10)},isNumber:function(e){return isFinite(e)&&!isNaN(parseFloat(e))},isString:function(e){return"string"==typeof e},forEach:function(e,t){var n,o,r;o=[];for(n in e)r=e[n],e.hasOwnProperty(n)&&o.push(t(r,n));return o},reverseForIn:function(e,t){var n,o,r;n=[];for(r in e)n.push(r);for(o=n.length-1;o>=0;)t.call(e,n[o],e[n[o]]),o--}},HPP.Helpers={Url:{createForElement:function(e,t,n,o){var r,l,i,s,a;if(l=n.getCollection(),s=l.getScheme(),r=s.getApiUrl(),!r)throw new Error("Api url has not yet been set");return o.path?(i=HPP.Helpers.Url.trimSlashes(o.path),a=r+"/"+i):(a=r+"/"+l.getName(),t.without_selector||"POST"===e||(a=a+"/"+n.getSelectorValue())),t.method&&(a=a+"/"+(t.path||e)),o.suffix&&(a=a+"/"+o.suffix),a},createForCollection:function(e,t,n){var o;return o=t.getScheme().getApiUrl()+"/"+t.getName(),n.suffix&&(o=o+"/"+n.suffix),o},trimSlashes:function(e){return e.replace(/\/$/,"").replace(/^\//,"")}},Element:{toData:function(e){var t,n,o;return t=e.getCollection(),o=HPP.Helpers.Element.getFields(e),n=o},getFields:function(e){var t,n,o,r,l,i,s;t=e.getCollection(),s=t.getScheme(),l={},i=s.data.collections[t.getName()].fields;for(n in i)o=i[n],o.only_receive||o.embedded_collection||o.embedded_element||(r=e.getField(n),l[n]=r);return l}},Collection:{getSettings:function(e){return e.getScheme().data.collections[e.getName()]},getSingularName:function(e){return HPP.Helpers.Collection.getSettings(e).singular}},Field:{}},HPP.Helpers.Snapshot={getSortedArray:function(e){var t;return t=Object.values(e),t.sort(function(e,t){return e.time-t.time}),t},removeAfter:function(e,t){var n,o,r,l,i;for(n=HPP.Helpers.Snapshot.getSortedArray(t),l={},o=0,r=n.length;o<r;o++)i=n[o],i.time<=e&&(l[i.time]=i);return l}},HPP.Helpers.Collection.doGetAllAction=function(e,t){var n,o,r;return null==t&&(t={}),n=t.data,o=getOptions("GET",HPP.Helpers.Url.createForCollection("GET",e,t),n,t.headers),r=HPP.http_function(o),r.then(function(t){var n,o,r,l,i;for(l=t.data,i=[],n=0,o=l.length;n<o;n++)r=l[n],i.push(e.makeOrMerge(r));return i}),r},HPP.Helpers.Collection.doGetOneAction=function(e,t,n){var o,r,l;return null==n&&(n={}),o=n.data,r=getOptions("GET",HPP.Helpers.Url.createForCollection("GET",e,{suffix:t}),o,n.headers),l=HPP.http_function(r),l.then(function(t){return e.makeOrMerge(t.data)}),l},HPP.Helpers.Collection.doCustomAction=function(e,t,n,o){var r,l,i;return null==o&&(o={}),l=n.method.toUpperCase(),r=o.data,i=getOptions(l,HPP.Helpers.Url.createForCollection("GET",e,{suffix:n.path||t}),r,o.headers),HPP.http_function(i)},HPP.Helpers.Element.setupBelongsToRelation=function(e,t,n){var o,r,l,i,s;return o=e.getCollection(),n.polymorphic||(s=n.collection?o.getScheme().getCollection(n.collection):o.getScheme().getCollectionBySingularName(t)),n.polymorphic?(r=n.collection_field||t+"_collection",l=n.collection_selector_field,i=n.field,e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HPP.Helpers.Element.getPolymorphicBelongsToElement(e,i,r,l,t)}):(i=n.field||t+"_"+s.selector_name,e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HPP.Helpers.Element.getBelongsToElement(e,s,i)})},HPP.Helpers.Element.getBelongsToElement=function(e,t,n){var o;return o=e.getField(n,!0,"belongs_to"),t.find(o)||null},HPP.Helpers.Element.getPolymorphicBelongsToElement=function(e,t,n,o,r){var l,i,s;return i=e.getField(n,!0,"belongs_to_collection"),l=e.getCollection().getScheme().getCollection(i),t||(o||(o=l.selector_name),t=r+"_"+o),s=e.getField(t,!0,"belongs_to"),l.find(s)||null},HPP.Helpers.Element.setupHasManyRelation=function(e,t,n){var o,r,l,i,s;return o=e.getCollection(),r=HPP.Helpers.Collection.getSettings(e.getCollection()),i=o.getScheme().getCollection(n.collection||t),l=n.references_field||t+"_"+i.selector_name+"s",(s=r.fields[l])?e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HPP.Helpers.Element.getHasManyRelationArrayThroughReferencesField(e,i,field_name)}:e.relations["get"+HP.Util.upperCamelize(t)]=HPP.Helpers.Element.getHasManyRelationFunction(e,o,n,i)},HPP.Helpers.Element.getHasManyRelationFunction=function(e,t,n,o){var r,l,i,s;return r=t.getSingularName(),s=HPP.Helpers.Collection.getSettings(o),n.polymorphic?(i=n.as+"_"+t.selector_name,l=n.as+"_collection",function(){return HPP.Helpers.Element.getPolymorphicHasManyRelationArray(e,o,i,l)}):(i=n.field?n.field:n.as?n.as+"_"+t.selector_name:r+"_"+t.selector_name,function(){return HPP.Helpers.Element.getHasManyRelationArray(e,o,i)})},HPP.Helpers.Element.getHasManyRelationArray=function(e,t,n){var o,r,l,i,s,a;for(r=[],a=e.getSelectorValue(),s=t.getArray(),l=0,i=s.length;l<i;l++)o=s[l],a===o.getField(n,!0,"has_many")&&r.push(o);return r},HPP.Helpers.Element.getPolymorphicHasManyRelationArray=function(e,t,n,o){var r,l,i,s,a,c,u;for(i=[],u=e.getSelectorValue(),r=e.getCollection().getName(),c=t.getArray(),s=0,a=c.length;s<a;s++)l=c[s],u===l.getField(n,!0,"has_many")&&r===l.getField(o,!0,"has_many_collection_name")&&i.push(l);return i},HPP.Helpers.Element.getHasManyRelationArrayThroughReferencesField=function(e,t,n){var o,r,l,i,s,a;if(a=e.getField(n,!0,"has_many_array"),!Array.isArray(a))throw new Error("Field "+n+" is not an array, but it should be an array of references to "+t.getName());for(r=[],s=t.getArray(),l=0,i=s.length;l<i;l++)o=s[l],a.includes(e.getSelectorValue())&&r.push(o);return r},HPP.Helpers.Element.setupHasOneRelation=function(e,t,n){var o,r,l,i;return o=e.getCollection(),r=HPP.Helpers.Collection.getSettings(e.getCollection()),i=o.getScheme(),l=n.collection?i.getCollection(n.collection):i.getCollectionBySingularName(t),e.relations["get"+HP.Util.upperCamelize(t)]=function(){return HPP.Helpers.Element.getHasManyRelationFunction(e,o,n,l)()[0]}},getOptions=function(e,t,n,o){return null==o&&(o={}),o.Accept=o["Content-Type"]="application/json",{method:e,url:t,data:JSON.stringify(n||{}),headers:o,dataType:"json",responseType:"json"}},HPP.Helpers.Element.doAction=function(e,t,n){var o,r,l;if(null==n&&(n={}),e.makeSnapshot("before_"+t.toLowerCase()),n.data?o=n.data:"GET"!==t&&(o=HPP.Helpers.Element.toData(e)),"POST"===t){if(!e.isNew())throw new Error("Element is not new")}else if(e.isNew())throw new Error("Element is new");return r=getOptions(t,HPP.Helpers.Url.createForElement(t,{},e,n),o,n.headers),l=HPP.http_function(r),l.then(function(n){var o;if(n.data&&e.mergeWith(n.data),e.makeSnapshot("after_"+t.toLowerCase()),o=e.getCollection(),o.new_elements.includes(e))return HP.Util.removeFromArray(o.new_elements,e),o.elements[e.getSelectorValue()]=e}),l},HPP.Helpers.Element.doCustomAction=function(e,t,n,o){var r,l,i,s;return null==o&&(o={}),l=n.method.toUpperCase(),e.makeSnapshot("before_"+l.toLowerCase()),o.data?r=o.data:n.without_data||(r=HPP.Helpers.Element.toData(e)),i=getOptions(l,HPP.Helpers.Url.createForElement(t,n,e,o),r,o.headers),s=HPP.http_function(i),s.then(function(t){var o;if(t.data&&!n.returns_other&&e.mergeWith(t.data),e.makeSnapshot("after_"+l.toLowerCase()),o=e.getCollection(),o.new_elements.includes(e))return HP.Util.removeFromArray(o.new_elements,e),o.elements[e.getSelectorValue()]=e}),s},HPP.Helpers.Field.handleEmbeddedCollection=function(e,t,n,o){var r,l,i;return r=e.getCollection(),i=r.getScheme(),l=i.getCollection(n||o.collection),HP.Util.forEach(t[n],function(e){var t;return t=new HP.Element(l,e),l.addElement(t)})},HPP.Helpers.Field.handleEmbeddedElement=function(e,t,n,o){var r,l,i,s,a;return l=e.getCollection(),a=l.getScheme(),s=o.collection?a.getCollection(o.collection):a.getCollectionBySingularName(n),i=s.makeOrMerge(t[n]),r=o.associated_field||n+"_"+s.selector_name,e.setField(r,i.getSelectorValue())};