!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Elpong",[],t):"object"==typeof exports?exports.Elpong=t():e.Elpong=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e["default"]}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=24)}([function(e,t,n){"use strict";var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};if("undefined"==typeof o)var o=!0;if(o)var i={schmnf:"Scheme not found",collnf:"Collection not found","collnf:s":"Collection not found by singular name",collex:"Collection with name already exists in scheme",elpgns:"No scheme tags found",elpnce:"No collection or element tags found",confns:"Configuration has no selector",confnn:"Configuration has no name",elenew:"Element is new",elesna:"Element has a selector value but is in new_elements array",elense:"Element has no selector value but is in elements object",apinur:"Api url has not yet been set",fldnsa:"Field should be an array of selectors",elesch:"Element selector changed",elesnf:"Snapshot not found",elesti:"Invalid snapshot identifier: must be number <= list.length, string or RegExp",eleafw:"Pre element has an associated field that does not match the embedded element selector",elesnm:"Selector is not matching get one request selector"};var s=function(e){function t(t,n){var r=this,s=o?i[t]:t;return r=n?e.call(this,s+": "+n)||this:e.call(this,s)||this}return r(t,e),t}(Error);t.ElpongError=s},function(e,t,n){"use strict";t.Util={capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},camelize:function(e){return e.replace(/_/g," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return 0===t?e.toLowerCase():e.toUpperCase()}).replace(/\s+/g,"")},removeFromArray:function(e,t){var n=e.indexOf(t);return n!==-1&&(e.splice(n,n+1),!0)},isInteger:function(e){return e===parseInt(e,10)},isNumber:function(e){return isFinite(e)&&!isNaN(parseFloat(e))},isString:function(e){return"string"==typeof e},isRegExp:function(e){return"[object RegExp]"==Object.prototype.toString.call(e)},forEach:function(e,t){for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];t(r,n)}},endsWith:function(e,t){return e.endsWith?e.endsWith(t):e.substr(-t.length)===t},startsWith:function(e,t){return e.startsWith?e.startsWith(t):e.substr(0,t.length)===t},arrayFromHTML:function(e){return Array.from?Array.from(e):[].slice.call(e)},values:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&e.propertyIsEnumerable(n)&&t.push(e[n]);return t},includes:function(e,t){return e.indexOf(t)>-1},equalsJSON:function(e,n){for(var r in e){var o=e[r],i=n[r];if("object"==typeof o){if(!t.Util.equalsJSON(o,i))return!1}else if(o!==i)return!1}return!0},copyJSON:function(e){return JSON.parse(JSON.stringify(e))}}},function(e,t,n){"use strict";var r;!function(e){function t(e){return e.scheme().configuration().collections[e.name]}function n(e){return t(e).singular}function r(e,t){var n;(n=t.selector())?e.elements[n]=t:e.new_elements.push(t)}e.getConfiguration=t,e.getSingularName=n,e.addElement=r}(r=t.CollectionHelper||(t.CollectionHelper={}))},function(e,t,n){"use strict";var r;!function(e){function t(e,t,n,o){o||(o={}),o.Accept=o["Content-Type"]="application/json";var i={method:t,url:e,data:JSON.stringify(void 0===n?{}:n),headers:o,dataType:"json",responseType:"json"};return i.type=i.method,i.body=i.data,r(i.url,i)}function n(e,t){switch("undefined"==typeof t&&("undefined"!=typeof jQuery&&e===jQuery.ajax?t="jquery":"undefined"!=typeof fetch&&e===fetch&&(t="fetch")),t){case"jquery":r=function(t,n){var r=jQuery.Deferred(),o=e(t,n);return o.then(function(e,t,n){return r.resolve({data:e,status:n.statusCode().status,headers:n.getAllResponseHeaders()})}),o["catch"](function(e,t,n){return r.reject({data:e,status:n.statusCode().status,headers:n.getAllResponseHeaders()})}),r.promise()};break;case"fetch":r=function(t,n){return new Promise(function(r,o){n.body=n.data;var i=e(t,n);i.then(function(e){if("application/json"!==e.headers.get("content-type"))r(e);else{var t=e.json();t.then(function(t){e.data=t,r(e)}),t["catch"](o)}}),i["catch"](o)})};break;default:r=function(t,n){return e(n)}}}var r;e.executeRequest=t,e.setAjaxFunction=n}(r=t.Ajax||(t.Ajax={}))},function(e,t,n){"use strict";function r(e){return!(!e&&0!==e&&""!==e||"string"!=typeof e&&"number"!=typeof e)}var o=n(1),i=n(17),s=n(18),l=n(16),c=n(21),a=n(10),u=n(9),f=n(0);t.isSelectorValue=r;var h=function(){function e(e,t){this.fields={},this.relations={},this.actions={},this.snapshots={},this._collection=e;var n=e.configuration();i.Fields.setup(this,n.fields,t),s.Relations.setup(this,n.relations),l.Actions.setup(this,n.actions),c.Snapshots.setup(this),this.snapshots.make("creation")}return e.prototype.collection=function(){return this._collection},e.prototype.selector=function(){return this.fields[this.collection().scheme().configuration().selector]},e.prototype.remove=function(){var e,t=this;return(e=this.selector())?this.actions["delete"]().then(function(){var n=t.collection().elements;delete n[e]}):(o.Util.removeFromArray(this.collection().new_elements,this),{then:function(e){return e()},"catch":function(){}})},e.prototype.save=function(){return this.isNew()?this.actions.post():this.actions.put()},e.prototype.isNew=function(){if(o.Util.includes(this.collection().new_elements,this)){if(this.selector())throw new f.ElpongError("elesna");return!0}if(this.selector())return!1;throw new f.ElpongError("elense")},e.prototype.merge=function(e){var t=this,n=this.collection().configuration(),i=this.collection().scheme().configuration().selector;return o.Util.forEach(n.fields,function(n,o){var s;if(s=e[o])if(n.embedded_element)a.EmbeddedElement.handle(t,e,o,n);else if(n.embedded_collection)u.EmbeddedCollection.handle(t,e,o,n);else if(o===i){var l=t.fields[o];if(l!==s&&r(l)&&r(s))throw new f.ElpongError("elesch",l+" -> "+s);t.fields[o]=s}else t.fields[o]=s}),this},e}();t.Element=h},function(e,t,n){"use strict";var r,o=n(0),i=n(2);!function(e){function t(e,t){for(var n in e._collections){var r=e.select(n);if(i.CollectionHelper.getSingularName(r)===t)return r}throw new o.ElpongError("collnf:s",t)}e.getCollectionBySingularName=t}(r=t.SchemeHelper||(t.SchemeHelper={}))},function(e,t,n){"use strict";var r,o=n(0);!function(e){function t(t,n,r,i,s){var l,c,a=r.collection(),u=a.scheme(),f=u.getApiUrl();if(!f)throw new o.ElpongError("apinur");return i.path?(l=e.trimSlashes(i.path),c=f+"/"+l):(c=f+"/"+a.name,n.no_selector||s||(c=c+"/"+r.selector())),n.method&&(c=c+"/"+(n.path||t)),i.suffix&&(c=c+"/"+i.suffix),c}function n(e,t,n){var r=t.scheme().getApiUrl();if(!r)throw new o.ElpongError("apinur");var i=r+"/"+t.name;return n.suffix&&(i=i+"/"+n.suffix),i}function r(e){return e.replace(/^\/|\/$/g,"")}function i(e){return/^https?:\/\//.test(e)}e.createForElement=t,e.createForCollection=n,e.trimSlashes=r,e.isFqdn=i}(r=t.UrlHelper||(t.UrlHelper={}))},function(e,t,n){"use strict";var r,o=n(22),i=n(0),s=n(1),l=n(3),c={},a=!1;!function(e){function t(e){var t=new o.Scheme(e);return c[t.name]=t}function n(e){var t;if(t=c[e])return t;throw new i.ElpongError("schmnf",e)}function r(t){if("undefined"!=typeof document){var n=document.querySelectorAll("meta[name=elpong-scheme]");if(!t&&!n.length)throw new i.ElpongError("elpgns");for(var r=0,o=s.Util.arrayFromHTML(n);r<o.length;r++){var l=o[r];e.add(JSON.parse(l.content))}}}function u(e){l.Ajax.setAjaxFunction(e)}function f(){a=!0,e.load(!0)}function h(){return a}function p(){a=!1,c={}}e.add=t,e.get=n,e.load=r,e.setAjax=u,e.enableAutoload=f,e.isAutoload=h,e.tearDown=p}(r=t.Elpong||(t.Elpong={}))},function(e,t,n){"use strict";var r=n(6);t.UrlHelper=r.UrlHelper;var o=n(2);t.CollectionHelper=o.CollectionHelper},function(e,t,n){"use strict";var r,o=n(4),i=n(1),s=n(2);!function(e){function t(e,t,n,r){var l;if(l=t[n]){var c=e.collection(),a=c.scheme(),u=a.select(n||r.collection);i.Util.forEach(l,function(e){var t=new o.Element(u,e);s.CollectionHelper.addElement(u,t)})}}e.handle=t}(r=t.EmbeddedCollection||(t.EmbeddedCollection={}))},function(e,t,n){"use strict";var r,o=n(5),i=n(0);!function(e){function t(e,t,n,r){var s,l=t[n];if(l){var c=e.collection(),a=c.scheme();s=r.collection?a.select(r.collection):o.SchemeHelper.getCollectionBySingularName(a,n);var u=s.buildOrMerge(l),f=r.field||n+"_"+a.configuration().selector,h=u.selector(),p=t[f];if(p&&p!=h)throw new i.ElpongError("eleafw",p+" != "+h);e.fields[f]=h}}e.handle=t}(r=t.EmbeddedElement||(t.EmbeddedElement={}))},function(e,t,n){"use strict";var r,o=n(2),i=n(1),s=n(0);!function(e){function t(e,t,r){var o,s=e.collection(),l=s.configuration(),a=s.scheme().select(r.collection||t),u=r.references_field||t+"_"+s.scheme().configuration().selector+"s";return(o=l.fields[u])?e.relations[i.Util.camelize(t)]=function(){return c(e,a,u)}:e.relations[i.Util.camelize(t)]=n(e,s,r,a)}function n(e,t,n,i,s){var c,a=o.CollectionHelper.getSingularName(t),u=(i.configuration(),t.scheme().configuration().selector);if(n.polymorphic){c=n.as+"_"+u;var f=n.as+"_collection";return function(){return l(e,i,c,f,s)}}return c=n.field?n.field:n.as?n.as+"_"+u:a+"_"+u,function(){return r(e,i,c,s)}}function r(e,t,n,r){for(var o=[],i=e.selector(),s=0,l=t.array();s<l.length;s++){var c=l[s];if(i===c.fields[n]&&(o.push(c),r))return o}return o}function l(e,t,n,r,o){for(var i=[],s=e.selector(),l=e.collection().name,c=0,a=t.array();c<a.length;c++){var u=a[c];if(s===u.fields[n]&&l===u.fields[r]&&(i.push(u),o))return i}return i}function c(e,t,n){var r=e.fields[n];if(!Array.isArray(r))throw new s.ElpongError("fldnrf",n);for(var o=[],l=0,c=t.array();l<c.length;l++){var a=c[l];i.Util.includes(r,e.selector())&&o.push(a)}return o}e.setup=t,e.getHasManyRelationFunction=n}(r=t.HasMany||(t.HasMany={}))},function(e,t,n){"use strict";var r,o=n(1);!function(e){function t(e,t){var n=e.collection(),r=n.scheme(),i={},s=r.configuration().collections[n.name].fields;for(var l in s){var c=s[l];if(!(c.no_send||c.embedded_collection||c.embedded_element)){var a=e.fields[l];t&&"object"==typeof a?i[l]=o.Util.copyJSON(a):i[l]=a}}return i}e.toData=t}(r=t.ElementHelper||(t.ElementHelper={}))},function(e,t,n){"use strict";var r=n(8),o=n(4),i=n(1),s=n(15),l=n(0),c=function(){function e(e,t){var n=this;this._scheme=e,this.name=t,this.elements={},this.new_elements=[],this.default_pre_element={};var o=r.CollectionHelper.getConfiguration(this);for(var l in o.fields){var c=o.fields[l];c["default"]&&(this.default_pre_element[l]=c["default"])}this.actions={getAll:function(e){return s.Actions.executeGetAll(n,e)},getOne:function(e,t){return s.Actions.executeGetOne(n,e,t)}},i.Util.forEach(o.collection_actions,function(e,t){n.actions[i.Util.camelize(t)]=function(r){return s.Actions.executeCustom(n,t,e,r)}})}return e.prototype.scheme=function(){return this._scheme},e.prototype.load=function(e){var t=this;if("undefined"!=typeof document){var n=document.querySelectorAll("meta[name=elpong-collection][collection='"+this.name+"'][scheme='"+this.scheme().name+"']"),r=document.querySelectorAll("meta[name=elpong-element][collection='"+this.name+"'][scheme='"+this.scheme().name+"']");if(!e&&!n.length&&!r.length)throw new l.ElpongError("elpnce");for(var o=0,s=i.Util.arrayFromHTML(n);o<s.length;o++)for(var c=s[o],a=0,u=JSON.parse(c.content);a<u.length;a++){var f=u[a];this.buildOrMerge(f)}i.Util.arrayFromHTML(r).map(function(e){return t.buildOrMerge(JSON.parse(e.content))})}},e.prototype.configuration=function(){return r.CollectionHelper.getConfiguration(this)},e.prototype.array=function(e){e||(e={no_new:!1});var t=e.no_new?[]:this.new_elements;return t.concat(i.Util.values(this.elements))},e.prototype.find=function(e){return this.elements[e]||null},e.prototype.findBy=function(e,t){t||(t={});for(var n,r=this.array(t),o=[],i=0,s=r;i<s.length;i++){var l=s[i];n=!0;for(var c in e){var a=e[c];if(l.fields[c]!==a){n=!1;break}}if(n){if(!t.multiple)return l;o.push(l)}}return t.multiple?o:null},e.prototype.build=function(e){e||(e=this.default_pre_element);var t=new o.Element(this,e);return r.CollectionHelper.addElement(this,t),t},e.prototype.buildOrMerge=function(e){var t;if(t=e[this.scheme().configuration().selector]){var n=void 0;return(n=this.find(t))?n.merge(e):this.build(e)}return this.build(e)},e}();t.Collection=c},function(e,t,n){"use strict";var r=n(0);if("undefined"==typeof o)var o=!0;var i=function(){function e(e){if(this.name=e.name,o&&!this.name)throw new r.ElpongError("confnn");if(this.selector=e.selector,o&&!this.selector)throw new r.ElpongError("confns",e.name);this.collections={};for(var t in e.collections){for(var n=e.collections[t],i=this.collections[t]={singular:n.singular||t.slice(0,-1)},s=["fields","relations","actions","collection_actions"],l=["has_many","has_one","belongs_to"],c=0,a=s;c<a.length;c++){var u=a[c];i[u]=n[u]||{}}var f=void 0;if(f=n.relations)for(var h=0,p=l;h<p.length;h++){var d=p[h];f[d]=n.relations[d]||{}}}}return e}();t.SchemeConfiguration=i},function(e,t,n){"use strict";var r,o=n(3),i=n(6),s=n(0);!function(e){function t(e,t){t||(t={});var n=t.data,r=o.Ajax.executeRequest(i.UrlHelper.createForCollection("GET",e,t),"GET",n,t.headers);return r.then(function(t){t.data.map(function(t){e.buildOrMerge(t)})}),r}function n(e,t,n){n||(n={});var r=n.data,l=o.Ajax.executeRequest(i.UrlHelper.createForCollection("GET",e,{suffix:t}),"GET",r,n.headers);return l.then(function(n){if(n.data){var r=e.scheme().configuration().selector;if(n.data[r]!==t)throw new s.ElpongError("elesnm",n.data[r]+" != "+t);e.buildOrMerge(n.data)}}),l}function r(e,t,n,r){r||(r={});var s=r.data,l=n.method.toUpperCase();return o.Ajax.executeRequest(i.UrlHelper.createForCollection("GET",e,{suffix:n.path||t}),l,s,r.headers)}e.executeGetAll=t,e.executeGetOne=n,e.executeCustom=r}(r=t.Actions||(t.Actions={}))},function(e,t,n){"use strict";var r,o=n(3),i=n(1),s=n(0),l=n(12),c=n(6);!function(e){function t(e,t){for(var o=function(t){e.actions[t]=function(r){return n(e,t.toUpperCase(),r)}},l=0,c=["get","post","put","delete"];l<c.length;l++){var a=c[l];o(a)}i.Util.forEach(t,function(t,n){e.actions[i.Util.camelize(n)]=function(o){if(e.isNew()&&!t.no_selector)throw new s.ElpongError("elenew");return r(e,n,t,o)}})}function n(e,t,n){n||(n={}),e.snapshots.make("before_"+t.toLowerCase());var r;if((r=n.data)?r=n.data:"GET"!==t&&(r=l.ElementHelper.toData(e)),"POST"===t){if(!e.isNew())throw new Error("Element is not new")}else if(e.isNew())throw new Error("Element is new");var s=o.Ajax.executeRequest(c.UrlHelper.createForElement(t,{},e,n,"POST"===t),t,r,n.headers);return s.then(function(n){n.data&&e.merge(n.data),e.snapshots.make("after_"+t.toLowerCase());var r=e.collection();i.Util.includes(r.new_elements,e)&&(i.Util.removeFromArray(r.new_elements,e),r.elements[e.selector()]=e)}),s}function r(e,t,n,r){r||(r={});var s=n.method.toUpperCase();e.snapshots.make("before_"+t);var a;r.data?a=r.data:n.no_data||(a=l.ElementHelper.toData(e));var u=o.Ajax.executeRequest(c.UrlHelper.createForElement(t,n,e,r),s,a,r.headers);return u.then(function(t){var r;n.returns_other||(t.data&&e.merge(t.data),e.snapshots.make("after_"+s.toLowerCase()));var o=e.collection();if((r=e.selector())&&i.Util.includes(o.new_elements,e))return i.Util.removeFromArray(o.new_elements,e),o.elements[r]=e}),u}e.setup=t,e.execute=n,e.executeCustom=r}(r=t.Actions||(t.Actions={}))},function(e,t,n){"use strict";var r,o=n(1),i=n(10),s=n(9);!function(e){function t(e,t,n){o.Util.forEach(t,function(t,r){if(t.embedded_element)i.EmbeddedElement.handle(e,n,r,t);else if(t.embedded_collection)s.EmbeddedCollection.handle(e,n,r,t);else{if(!n.hasOwnProperty(r))return;var o=n[r];e.fields[r]=o}})}e.setup=t}(r=t.Fields||(t.Fields={}))},function(e,t,n){"use strict";var r,o=n(1),i=n(11),s=n(20),l=n(19);!function(e){function t(e,t){o.Util.forEach(t.has_many,function(t,n){i.HasMany.setup(e,n,t)}),o.Util.forEach(t.has_one,function(t,n){s.HasOne.setup(e,n,t)}),o.Util.forEach(t.belongs_to,function(t,n){l.BelongsTo.setup(e,n,t)})}e.setup=t}(r=t.Relations||(t.Relations={}))},function(e,t,n){"use strict";var r,o=n(4),i=n(1),s=n(5);!function(e){function t(e,t,o){var l,c,a=e.collection();if(o.polymorphic){var u=o.collection_field||t+"_collection";l=o.field,e.relations[i.Util.camelize(t)]=function(){return r(e,l,u,t)}}else{var f=a.scheme();c=o.collection?a.scheme().select(o.collection):s.SchemeHelper.getCollectionBySingularName(f,t),l=o.field||t+"_"+f.configuration().selector,e.relations[i.Util.camelize(t)]=function(){return n(e,c,l)}}}e.setup=t;var n=function(e,t,n){var r=e.fields[n];return o.isSelectorValue(r)?t.find(r)||null:void 0},r=function(e,t,n,r){var o=e.fields[n],i=e.collection().scheme().select(o);if(!t){var s=e.collection().scheme().configuration().selector;t=r+"_"+s}var l=e.fields[t];return i.find(l)||null}}(r=t.BelongsTo||(t.BelongsTo={}))},function(e,t,n){"use strict";var r,o=n(11),i=n(5),s=n(1);!function(e){function t(e,t,n){var r,l=e.collection(),c=(e.collection().configuration(),l.scheme());return r=n.collection?c.select(n.collection):i.SchemeHelper.getCollectionBySingularName(c,t),e.relations[s.Util.camelize(t)]=function(){return o.HasMany.getHasManyRelationFunction(e,l,n,r,!0)()[0]}}e.setup=t}(r=t.HasOne||(t.HasOne={}))},function(e,t,n){"use strict";var r,o=n(1),i=n(23),s=n(0);!function(e){function t(e){var t=e.snapshots;t.list=[],t.make=function(t){return new i.Snapshot(e,t)},t.lastPersisted=function(){if(!e.isNew())for(var n=t.list.length-1;n>=0;n--){var r=t.list[n];if(o.Util.includes(["after_post","after_put","after_get","creation"],r.tag))return r}},t.lastWithTag=function(t){var n,r=e.snapshots.list;if(o.Util.isRegExp(t))for(var i=r.length-1;i>=0;i--){var s=r[i];if(s.tag&&t.test(s.tag))return s}else for(var i=r.length-1;i>=0;i--){var s=r[i];if(t===s.tag)return s}return n},t.last=function(){var t=e.snapshots.list;return t[t.length-1]},t.undo=function(n){if(null==n&&(n=0),o.Util.isInteger(n)){var r=e.snapshots.list;if(n<0||n>r.length)throw new s.ElpongError("elesti",""+n);var i=r[e.snapshots.current_index-n];i.revert()}else{var i=void 0;if(!(i=t.lastWithTag(n)))throw new s.ElpongError("elesnf",""+n);i.revert()}return e},t.isPersisted=function(){var n=t.lastPersisted();return!!n&&o.Util.equalsJSON(e.fields,n.data)}}e.setup=t}(r=t.Snapshots||(t.Snapshots={}))},function(e,t,n){"use strict";function r(e){return e instanceof i.SchemeConfiguration}var o=n(13),i=n(14),s=n(0),l=n(8),c=n(7),a=function(){function e(e){var t;t=r(e)?e:new i.SchemeConfiguration(e),this._configuration=t,this.name=t.name,this._collections={};for(var n in t.collections){var s=(t.collections[n],new o.Collection(this,n));this._collections[n]=s,c.Elpong.isAutoload()&&s.load(!0)}}return e.prototype.configuration=function(){return this._configuration},e.prototype.select=function(e){var t;if(t=this._collections[e])return t;throw new s.ElpongError("collnf",e)},e.prototype.setApiUrl=function(e){var t=this.api_url=l.UrlHelper.trimSlashes(e);if(!l.UrlHelper.isFqdn(t))return this.api_url="/"+t},e.prototype.getApiUrl=function(){return this.api_url},e}();t.Scheme=a},function(e,t,n){"use strict";var r=n(12),o=function(){function e(e,t){this.element=e,this.tag=t,this.data=r.ElementHelper.toData(e,!0),this.undone=!1,this.time=Date.now(),this.index=e.snapshots.list.length,e.snapshots.list.push(this),e.snapshots.current_index=this.index}return e.prototype.revert=function(){var e=this.element.snapshots.list;this.element.merge(this.data),this.element.snapshots.current_index=this.index,this.undone=!1;for(var t=this.index+1,n=e.length;t<n;t++)e[t].undone=!0},e}();t.Snapshot=o},function(e,t,n){"use strict";var r=n(7);e.exports=r.Elpong}])});