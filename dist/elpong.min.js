!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Elpong",[],t):"object"==typeof exports?exports.Elpong=t():e.Elpong=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";var r=n(1);e.exports=r.Elpong},function(e,t,n){"use strict";var r,o=n(2),i=n(6),l=n(11),c=n(9),s={};!function(e){function t(e){var t=new o.Scheme(e);return s[t.name]=t}function n(e){var t;if(t=s[e])return t;throw new i.ElpongError("schmnf",e)}function r(){var t=document.querySelectorAll("meta[name=elpong-scheme]");if(!t.length&&!Object.keys(s).length)throw new i.ElpongError("elpgns");for(var n=0,r=l.Util.arrayFromHTML(t);n<r.length;n++){var o=r[n];e.add(JSON.parse(o.content))}}function a(e){c.Ajax.setAjaxFunction(e)}e.add=t,e.get=n,e.load=r,e.setAjax=a}(r=t.Elpong||(t.Elpong={}))},function(e,t,n){"use strict";function r(e){return e instanceof i.SchemeConfiguration}var o=n(3),i=n(20),l=n(6),c=n(4),s=function(){function e(e){var t;t=r(e)?e:new i.SchemeConfiguration(e),this._configuration=t,this.name=t.name,this._collections={},this.api_url=null;for(var n in t.collections){t.collections[n];this._collections[n]=new o.Collection(this,n)}}return e.prototype.configuration=function(){return this._configuration},e.prototype.select=function(e){var t;if(t=this._collections[e])return t;throw new l.ElpongError("collnf",e)},e.prototype.setApiUrl=function(e){var t=this.api_url=c.UrlHelper.trimSlashes(e);if(!c.UrlHelper.isFqdn(t))return this.api_url="/"+t},e.prototype.getApiUrl=function(){return this.api_url},e}();t.Scheme=s},function(e,t,n){"use strict";var r=n(4),o=n(10),i=n(11),l=function(){function e(e,t){var n=this;this._scheme=e,this.name=t,this.elements={},this.new_elements=[],this.default_pre_element={};var o=r.CollectionHelper.getConfiguration(this);for(var l in o.fields){var c=o.fields[l];c["default"]&&(this.default_pre_element[l]=c["default"])}this.actions={getAll:function(e){return r.CollectionHelper.Actions.executeGetAll(this,e)},getOne:function(e,t){return r.CollectionHelper.Actions.executeGetOne(this,e,t)}},i.Util.forEach(o.collection_actions,function(e,t){n.actions[i.Util.camelize(t)]=function(o){r.CollectionHelper.Actions.executeCustom(n,t,e,o)}})}return e.prototype.scheme=function(){return this._scheme},e.prototype.load=function(){for(var e=this,t=document.querySelectorAll("meta[name=elpong-collection][collection='"+this.name+"'][scheme='"+this.scheme().name+"']"),n=document.querySelectorAll("meta[name=elpong-element][collection='"+this.name+"'][scheme='"+this.scheme().name+"']"),r=0,o=i.Util.arrayFromHTML(t);r<o.length;r++)for(var l=o[r],c=0,s=JSON.parse(l.content);c<s.length;c++){var a=s[c];this.buildOrMerge(a)}return i.Util.arrayFromHTML(n).map(function(t){return e.buildOrMerge(JSON.parse(t.content))})},e.prototype.configuration=function(){return r.CollectionHelper.getConfiguration(this)},e.prototype.array=function(e){e||(e={no_new:!1});var t=e.no_new?[]:this.new_elements;return t.concat(i.Util.values(this.elements))},e.prototype.find=function(e){return this.elements[e]},e.prototype.findBy=function(e,t){t||(t={});for(var n,r=this.array(t),o=[],i=0,l=r;i<l.length;i++){var c=l[i];n=!0;for(var s in e){var a=e[s];if(c.fields[s]!==a){n=!1;break}}if(n){if(!t.multiple)return c;o.push(c)}}return o},e.prototype.build=function(e){null==e&&(e=this.default_pre_element);var t=new o.Element(this,e);return r.CollectionHelper.addElement(this,t),t},e.prototype.buildOrMerge=function(e){var t;if(t=e[this.scheme().configuration().selector]){var n=void 0;return(n=this.find(t))?n.merge(e):this.build(e)}return this.build(e)},e}();t.Collection=l},function(e,t,n){"use strict";var r=n(5);t.UrlHelper=r.UrlHelper;var o=n(7);t.CollectionHelper=o.CollectionHelper},function(e,t,n){"use strict";var r,o=n(6);!function(e){function t(t,n,r,i){var l,c,s=r.collection(),a=s.scheme(),u=a.getApiUrl();if(!u)throw new o.ElpongError("apinur");return i.path?(l=e.trimSlashes(i.path),c=u+"/"+l):(c=u+"/"+s.name,n.no_selector||"POST"===t||(c=c+"/"+r.selector())),n.method&&(c=c+"/"+(n.path||t)),i.suffix&&(c=c+"/"+i.suffix),c}function n(e,t,n){var r=t.scheme().getApiUrl()+"/"+t.name;return n.suffix&&(r=r+"/"+n.suffix),r}function r(e){return e.replace(/\/$/,"").replace(/^\//,"")}function i(e){return/^https?:\/\//.test(e)}e.createForElement=t,e.createForCollection=n,e.trimSlashes=r,e.isFqdn=i}(r=t.UrlHelper||(t.UrlHelper={}))},function(e,t,n){"use strict";var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},o=!0;if(o)var i={schmnf:"Scheme not found",collnf:"Collection not found","collnf:s":"Collection not found by singular name",collex:"Collection with name already exists in scheme",elpgns:"No schemes added or found",confns:"Configuration has no selector",confnn:"Configuration has no name",elenew:"Element is new",elesna:"Element has a selector value but is in new_elements array",elense:"Element has no selector value but is in elements object",apinur:"Api url has not yet been set"};var l=function(e){function t(t,n){var r=this,l=o?i[t]:t;return r=n?e.call(this,l+": "+n)||this:e.call(this,l)||this}return r(t,e),t}(Error);t.ElpongError=l},function(e,t,n){"use strict";var r,o=n(8);!function(e){function t(e){return e.scheme().configuration().collections[e.name]}function n(e){return t(e).singular}function r(e,t){var n;(n=t.selector())?e.elements[n]=t:e.new_elements.push(t)}e.getConfiguration=t,e.getSingularName=n,e.addElement=r,e.Actions=o.Actions}(r=t.CollectionHelper||(t.CollectionHelper={}))},function(e,t,n){"use strict";var r,o=n(9),i=n(5);!function(e){function t(e,t){t||(t={});var n,r=t.data;return n=o.Ajax.executeRequest(i.UrlHelper.createForCollection("GET",e,t),"GET",r,t.headers),n.then(function(t){t.data.map(function(t){e.buildOrMerge(t)})}),n}function n(e,t,n){null==n&&(n={});var r=n.data,l=o.Ajax.executeRequest(i.UrlHelper.createForCollection("GET",e,{suffix:t}),"GET",r,n.headers);return l.then(function(t){if(t.data)return e.buildOrMerge(t.data)}),l}function r(e,t,n,r){null==r&&(r={});var l=r.data,c=n.method.toUpperCase();return o.Ajax.executeRequest(i.UrlHelper.createForCollection("GET",e,{suffix:n.path||t}),c,l,r.headers)}e.executeGetAll=t,e.executeGetOne=n,e.executeCustom=r}(r=t.Actions||(t.Actions={}))},function(e,t){"use strict";var n;!function(e){function t(e,t,n,o){null==o&&(o={}),o.Accept=o["Content-Type"]="application/json";var i={method:t,url:t,data:JSON.stringify(void 0===n?{}:n),headers:o,dataType:"json",responseType:"json"};return i.type=i.method,i.body=i.data,r(i.url,i)}function n(e,t){if("undefined"==typeof t)if("undefined"!=typeof jQuery&&e===jQuery.ajax)var t="jquery";else if("undefined"!=typeof fetch&&e===fetch)var t="fetch";switch(t){case"jquery":r=function(t,n){var r=jQuery.Deferred(),o=e(t,n);return o.then(function(e,t,n){return r.resolve({data:e,status:n.statusCode().status,headers:n.getAllResponseHeaders()})}),o["catch"](function(e,t,n){return r.reject({data:e,status:n.statusCode().status,headers:n.getAllResponseHeaders()})}),r.promise()};break;case"fetch":r=function(t,n){return new Promise(function(r,o){n.body=n.data;var i=e(t,n);i.then(function(e){if("application/json"!==e.headers.get("content-type"))r(e);else{var t=e.json();t.then(function(t){e.data=t,r(e)}),t["catch"](o)}}),i["catch"](o)})};break;default:this.ajax_function=function(t,n){return e(n)}}}var r;e.executeRequest=t,e.setAjaxFunction=n}(n=t.Ajax||(t.Ajax={}))},function(e,t,n){"use strict";var r=n(11),o=n(12),i=n(14),l=n(18),c=n(6),s=function(){function e(e,t){this.fields={},this.relations={},this.actions={},this._collection=e;var n=e.configuration();o.Fields.setup(this,n.fields,t),i.Relations.setup(this,n.relations),l.Actions.setup(this,n.actions),this.last_snapshot_time=null}return e.prototype.collection=function(){return this._collection},e.prototype.selector=function(){return this.fields[this.collection().scheme().configuration().selector]},e.prototype.remove=function(){var e=this;return this.isNew()?(r.Util.removeFromArray(this.collection().new_elements,this),{then:function(e){return e()},"catch":function(){}}):this.actions["delete"]().then(function(){var t=e.collection().elements;return delete t[e.selector()]})},e.prototype.save=function(){return this.isNew()?this.actions.post():this.actions.put()},e.prototype.isNew=function(){if(r.Util.includes(this.collection().new_elements,this)){if(this.selector())throw new c.ElpongError("elesna");return!0}if(this.selector())return!1;throw new c.ElpongError("elense")},e.prototype.merge=function(e){var t=this,n=this.collection().configuration();return r.Util.forEach(n.fields,function(n,r){var i;if(i=e[r])if(n.embedded_element)o.Fields.handleEmbeddedElement(t,e,r,n);else if(n.embedded_collection)o.Fields.handleEmbeddedCollection(t,e,r,n);else{var l=t.fields[r];if(n.selector&&l!==i&&l&&i)throw new Error("Selector has changed from "+l+" to "+i);t.fields[r]=i}}),this},e}();t.Element=s},function(e,t){"use strict";t.Util={BREAK:new Object,kebab:function(e){return e.toLowerCase().replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,"").replace(/(é|ë)/g,"e").split(" ").join("-")},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},camelize:function(e){return e.replace(/_/g," ").replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return 0===t?e.toLowerCase():e.toUpperCase()}).replace(/\s+/g,"")},arrayDiff:function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},removeFromArray:function(e,t){var n=e.indexOf(t);return n!==-1&&(e.splice(n,n+1),!0)},copy:function(e){if("object"!=typeof e)return e;var t=e.constructor();for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},merge:function(e,t){for(var n in t)e[n]=t[n];return e},isInteger:function(e){return e===parseInt(e,10)},isNumber:function(e){return isFinite(e)&&!isNaN(parseFloat(e))},isString:function(e){return"string"==typeof e},isRegex:function(e){return e instanceof RegExp},forEach:function(e,n){for(var r in e){var o=e[r];if(e.hasOwnProperty(r)&&n(o,r)===t.Util.BREAK)break}},reverseForIn:function(e,n){var r=[],o=!1;for(var i in e)r.push(i);for(var l=r.length-1;l>=0&&!o;){var c=n.call(e,r[l],e[r[l]]);c===t.Util.BREAK&&(o=!0),l--}},endsWith:function(e,t){return e.endsWith?e.endsWith(t):e.substr(-t.length)===t},startsWith:function(e,t){return e.startsWith?e.startsWith(t):e.substr(0,t.length)===t},arrayFromHTML:function(e){return Array.from?Array.from(e):[].slice.call(e)},values:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&e.propertyIsEnumerable(n)&&t.push(e[n]);return t},includes:function(e,t){return e.indexOf(t)>-1}}},function(e,t,n){"use strict";var r,o=n(10),i=n(11),l=n(13),c=n(7);!function(e){function t(e,t,o){i.Util.forEach(t,function(t,i){if(t.embedded_element)return n(e,o,i,t);if(t.embedded_collection)return r(e,o,i,t);var l=o[i];return e.fields[i]=l})}function n(e,t,n,r){var o,i=t[n];if(i){var c=e.collection(),s=c.scheme();o=r.collection?s.select(r.collection):l.SchemeHelper.getCollectionBySingularName(s,n);var a=o.buildOrMerge(i),u=n+"_"+s.configuration().selector;return e.fields[u]=a.selector()}}function r(e,t,n,r){var l;if(l=t[n]){var s=e.collection(),a=s.scheme(),u=a.select(n||r.collection);return i.Util.forEach(l,function(e){var t=new o.Element(u,e);return c.CollectionHelper.addElement(u,t)})}}e.setup=t,e.handleEmbeddedElement=n,e.handleEmbeddedCollection=r}(r=t.Fields||(t.Fields={}))},function(e,t,n){"use strict";var r,o=n(6),i=n(7);!function(e){function t(e,t){for(var n in e._collections){var r=e.select(n);if(i.CollectionHelper.getSingularName(r)===t)return r}throw new o.ElpongError("collnf:s",t)}e.getCollectionBySingularName=t}(r=t.SchemeHelper||(t.SchemeHelper={}))},function(e,t,n){"use strict";var r,o=n(11),i=n(15),l=n(16),c=n(17);!function(e){function t(e,t){o.Util.forEach(t.has_many,function(t,n){i.HasMany.setup(e,n,t)}),o.Util.forEach(t.has_one,function(t,n){l.HasOne.setup(e,n,t)}),o.Util.forEach(t.belongs_to,function(t,n){c.BelongsTo.setup(e,n,t)})}e.setup=t}(r=t.Relations||(t.Relations={}))},function(e,t,n){"use strict";var r,o=n(7),i=n(11);!function(e){function t(e,t,r){var o,l=e.collection(),s=l.configuration(),a=l.scheme().select(r.collection||t),u=r.references_field||t+"_"+l.scheme().configuration().selector+"s";return(o=s.fields[u])?e.relations[i.Util.camelize(t)]=function(){return c(e,a,u)}:e.relations[i.Util.camelize(t)]=n(e,l,r,a)}function n(e,t,n,i){var c,s=o.CollectionHelper.getSingularName(t),a=(i.configuration(),t.scheme().configuration().selector);if(n.polymorphic){c=n.as+"_"+a;var u=n.as+"_collection";return function(){return l(e,i,c,u)}}return c=n.field?n.field:n.as?n.as+"_"+a:s+"_"+a,function(){return r(e,i,c)}}function r(e,t,n){for(var r=[],o=e.selector(),i=0,l=t.array();i<l.length;i++){var c=l[i];o===e.fields[n]&&r.push(c)}return r}function l(e,t,n,r){for(var o=[],i=e.selector(),l=e.collection().name,c=0,s=t.array();c<s.length;c++){var a=s[c];i===a.fields[n]&&l===a.fields[r]&&o.push(a)}return o}function c(e,t,n){var r=e.fields[n];if(!Array.isArray(r))throw new Error("Field "+n+" is not an array, but it should be an array of references to "+t.name);for(var o=[],l=0,c=t.array();l<c.length;l++){var s=c[l];i.Util.includes(r,e.selector())&&o.push(s)}return o}e.setup=t,e.getHasManyRelationFunction=n}(r=t.HasMany||(t.HasMany={}))},function(e,t,n){"use strict";var r,o=n(15),i=n(13),l=n(11);!function(e){function t(e,t,n){var r,c=e.collection(),s=(e.collection().configuration(),c.scheme());return r=n.collection?s.select(n.collection):i.SchemeHelper.getCollectionBySingularName(s,t),e.relations[l.Util.camelize(t)]=function(){o.HasMany.getHasManyRelationFunction(e,c,n,r)()[0]}}e.setup=t}(r=t.HasOne||(t.HasOne={}))},function(e,t,n){"use strict";var r,o=n(11);!function(e){function t(e,t,i){var l,c,s=e.collection();if(i.polymorphic){var a=i.collection_field||t+"_collection";l=i.field,e.relations[o.Util.camelize(t)]=function(){return r(e,l,a,t)}}else c=s.scheme().select(i.collection||t),l=i.field||t+"_"+c.selector_name,e.relations[o.Util.camelize(t)]=function(){return n(e,c,l)}}e.setup=t;var n=function(e,t,n){var r=e.fields[n];return t.find(r)||null},r=function(e,t,n,r){var o=e.fields[n],i=e.collection().scheme().select(o);if(!t){var l=e.collection().scheme().configuration().selector;t=r+"_"+l}var c=e.fields[t];return i.find(c)||null}}(r=t.BelongsTo||(t.BelongsTo={}))},function(e,t,n){"use strict";var r,o=n(9),i=n(11),l=n(6),c=n(19),s=n(5);!function(e){function t(e,t){for(var o=function(t){e.actions[t]=function(r){return n(e,t.toUpperCase(),r)}},c=0,s=["get","post","put","delete"];c<s.length;c++){var a=s[c];o(a)}i.Util.forEach(t,function(t,n){e.actions[i.Util.camelize(n)]=function(o){if(e.isNew()&&!t.no_selector)throw new l.ElpongError("elenew");return r(e,n,t,o)}})}function n(e,t,n){n||(n={});var r;if(n.data?r=n:"GET"!==t&&(r=c.ElementHelper.toData(e)),"POST"===t){if(!e.isNew())throw new Error("Element is not new")}else if(e.isNew())throw new Error("Element is new");var l=o.Ajax.executeRequest(s.UrlHelper.createForElement(t,{},e,n),t,r,n.headers);return l.then(function(t){t.data&&e.merge(t.data);var n=e.collection();if(i.Util.includes(n.new_elements,e))return i.Util.removeFromArray(n.new_elements,e),n.elements[e.selector()]=e}),l}function r(e,t,n,r){null==r&&(r={});var l=n.method.toUpperCase();e.snapshots.make("before_"+l.toLowerCase());var a;r.data?a=r.data:n.without_data||(a=c.ElementHelper.toData(e));var u=o.Ajax.executeRequest(s.UrlHelper.createForElement(t,n,e,r),l,a,r.headers);return u.then(function(t){var r;n.returns_other||(t.data&&e.mergeWith(t.data),e.snapshots.make("after_"+l.toLowerCase()));var o=e.getCollection();if((r=e.getSelectorValue())&&i.Util.includes(o.new_elements,e))return i.Util.removeFromArray(o.new_elements,e),o.elements[r]=e}),u}e.setup=t,e.execute=n,e.executeCustom=r}(r=t.Actions||(t.Actions={}))},function(e,t){"use strict";var n;!function(e){function t(e){var t=e.collection(),n=t.scheme(),r={},o=n.configuration().collections[t.name].fields;for(var i in o){var l=o[i];if(!(l.no_send||l.embedded_collection||l.embedded_element)){var c=e.fields[i];r[i]=c}}return r}e.toData=t}(n=t.ElementHelper||(t.ElementHelper={}))},function(e,t,n){"use strict";var r=n(6),o=!0,i=function(){function e(e){if(this.name=e.name,o&&!this.name)throw new r.ElpongError("confnn");if(this.selector=e.selector,o&&!this.selector)throw new r.ElpongError("confns",e.name);this.collections={};for(var t in e.collections){for(var n=e.collections[t],i=this.collections[t]={singular:n.singular||t.slice(0,-1)},l=["fields","relations","actions","collection_actions"],c=["has_many","has_one","belongs_to"],s=0,a=l;s<a.length;s++){var u=a[s];i[u]=n[u]||{}}if(n.relations)for(var f=0,h=c;f<h.length;f++){var p=h[f];i.relations[p]=n.relations[p]||{}}}}return e}();t.SchemeConfiguration=i}])});